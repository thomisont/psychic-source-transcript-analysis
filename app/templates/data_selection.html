{% extends "base.html" %}

{% block title %}Data Selection - Psychic Source Analyzer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-database me-2"></i>Conversation Data Selection
                </h5>
            </div>
            <div class="card-body">
                <form id="data-filter-form" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="start-date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start-date" name="start_date" value="{{ start_date }}">
                        </div>
                        <div class="col-md-3">
                            <label for="end-date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end-date" name="end_date" value="{{ end_date }}">
                        </div>
                        <div class="col-md-4">
                            <label for="conversation-id" class="form-label">Conversation ID (optional)</label>
                            <input type="text" class="form-control" id="conversation-id" name="conversation_id" placeholder="Enter conversation ID">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100" id="search-button">
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Loading indicator -->
                <div id="loading-indicator" class="text-center py-5 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading conversation data...</p>
                </div>
                
                <!-- Error message -->
                <div id="error-message" class="alert alert-danger d-none">
                    Failed to load conversation data. Please try again.
                </div>
                
                <!-- Initial instructions -->
                <div id="initial-instructions" class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    Please select a date range above and click "Search" to load conversation data.
                </div>
                
                <div class="table-responsive">
                    <table id="conversations-table" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Duration (s)</th>
                                <th>Turns</th>
                                <th>Status</th>
                                <th>ID</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded via JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="d-flex justify-content-end mt-3">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exportModal">
                        <i class="fas fa-file-export me-2"></i>Export Data
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Conversation Details Modal -->
<div class="modal fade" id="conversationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Conversation Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Tabbed navigation -->
                <ul class="nav nav-tabs" id="conversationTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview-content" type="button" role="tab" aria-controls="overview" aria-selected="true">Overview</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="transcription-tab" data-bs-toggle="tab" data-bs-target="#transcription-content" type="button" role="tab" aria-controls="transcription" aria-selected="false">Transcription</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="client-data-tab" data-bs-toggle="tab" data-bs-target="#client-data-content" type="button" role="tab" aria-controls="client-data" aria-selected="false">Client data</button>
                    </li>
                </ul>
                <div class="tab-content p-3" id="conversationTabContent">
                    <div class="tab-pane fade show active" id="overview-content" role="tabpanel" aria-labelledby="overview-tab">
                        <!-- Overview content will be loaded here -->
                    </div>
                    <div class="tab-pane fade" id="transcription-content" role="tabpanel" aria-labelledby="transcription-tab">
                        <!-- Transcription content will be loaded here -->
                    </div>
                    <div class="tab-pane fade" id="client-data-content" role="tabpanel" aria-labelledby="client-data-tab">
                        <!-- Client data content will be loaded here -->
                    </div>
                </div>
                <div id="conversation-details-content" class="d-none">
                    <!-- Original conversation details will be loaded here but hidden -->
                </div>
            </div>
            <div class="modal-footer">
                <div class="btn-group dropdown">
                    <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-file-export me-2"></i>Export
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item export-conversation" data-format="json" href="#">JSON</a></li>
                        <li><a class="dropdown-item export-conversation" data-format="csv" href="#">CSV</a></li>
                        <li><a class="dropdown-item export-conversation" data-format="md" href="#">Markdown</a></li>
                    </ul>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Export Data</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="export-form">
                    <div class="mb-3">
                        <label class="form-label">Export Format</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="export-format" id="format-json" value="json" checked>
                            <label class="form-check-label" for="format-json">JSON</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="export-format" id="format-csv" value="csv">
                            <label class="form-check-label" for="format-csv">CSV</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="export-format" id="format-md" value="md">
                            <label class="form-check-label" for="format-md">Markdown</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="export-button">Export</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentConversationId = null;
    let dataTable = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize DataTable
        dataTable = $('#conversations-table').DataTable({
            columns: [
                { 
                    data: 'start_time', 
                    render: function(data) {
                        return data ? new Date(data).toLocaleString() : 'Unknown';
                    }
                },
                { 
                    data: 'end_time', 
                    render: function(data) {
                        return data ? new Date(data).toLocaleString() : 'Unknown';
                    }
                },
                { data: 'duration' },
                { data: 'turn_count' },
                { 
                    data: 'status',
                    render: function(data) {
                        const statusClass = getStatusClass(data || 'unknown');
                        return `<span class="badge ${statusClass}">${data || 'Unknown'}</span>`;
                    }
                },
                { data: 'conversation_id' },
                {
                    data: null,
                    orderable: false,
                    render: function(data) {
                        return `
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-primary view-conversation" data-id="${data.conversation_id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-info analyze-conversation" data-id="${data.conversation_id}">
                                    <i class="fas fa-chart-bar"></i>
                                </button>
                            </div>`;
                    }
                }
            ],
            order: [[0, 'asc']], // Set default sort to ascending by start date
            // Keep table hidden initially
            "dom": 'rtip',
            "paging": true,
            "searching": true,
            "info": true,
            "language": {
                "emptyTable": "No conversations found"
            }
        });
        
        // Don't load initial data - wait for search
        // Show initial instructions instead
        $('#initial-instructions').show();
        $('.dataTables_wrapper').hide();
        
        // Set up event listeners
        document.getElementById('data-filter-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const searchButton = document.getElementById('search-button');
            searchButton.disabled = true;
            searchButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Searching...';
            
            // Clear previous data and results
            dataTable.clear().draw();
            
            // Check if we're searching by conversation ID
            const conversationId = document.getElementById('conversation-id').value.trim();
            if (conversationId) {
                // If we have a conversation ID, view it directly
                viewConversation(conversationId);
                searchButton.disabled = false;
                searchButton.innerHTML = '<i class="fas fa-search me-2"></i>Search';
            } else {
                // Otherwise, load conversations by date range
                loadConversations(function() {
                    searchButton.disabled = false;
                    searchButton.innerHTML = '<i class="fas fa-search me-2"></i>Search';
                    
                    // Hide instructions and show table after search
                    $('#initial-instructions').hide();
                    $('.dataTables_wrapper').show();
                });
            }
        });
        
        // Add search functionality to DataTable
        $('#conversations-table_filter input').on('keyup', function() {
            dataTable.search(this.value).draw();
        });
        
        // Handle conversation view button
        $('#conversations-table').on('click', '.view-conversation', function() {
            const conversationId = $(this).data('id');
            viewConversation(conversationId);
        });
        
        // Handle conversation analyze button
        $('#conversations-table').on('click', '.analyze-conversation', function() {
            const conversationId = $(this).data('id');
            window.location.href = `/analysis?conversation_id=${conversationId}`;
        });
        
        // Handle export conversation
        $('.export-conversation').on('click', function(e) {
            e.preventDefault();
            const format = $(this).data('format');
            if (currentConversationId) {
                window.location.href = `/api/export/${format}?type=conversation&conversation_id=${currentConversationId}`;
            }
        });
        
        // Handle bulk export
        document.getElementById('export-button').addEventListener('click', function() {
            const format = document.querySelector('input[name="export-format"]:checked').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            window.location.href = `/api/export/${format}?type=conversations&start_date=${startDate}&end_date=${endDate}`;
            
            // Close the modal
            $('#exportModal').modal('hide');
        });
    });
    
    function loadConversations(callback) {
        // Get the date range values
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        // Validate that we have both dates before proceeding
        if (!startDate || !endDate) {
            // Show an error message if dates are missing
            document.getElementById('error-message').classList.remove('d-none');
            document.getElementById('error-message').textContent = 'Please select both a start and end date.';
            
            // Call the callback if provided
            if (typeof callback === 'function') {
                callback();
            }
            return;
        }
        
        // Show loading indicator
        document.getElementById('loading-indicator').classList.remove('d-none');
        document.getElementById('error-message').classList.add('d-none');
        
        // Fetch data from the API
        fetch(`/api/conversations?start_date=${startDate}&end_date=${endDate}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Hide loading indicator
                document.getElementById('loading-indicator').classList.add('d-none');
                
                // Clear existing data and add new
                dataTable.clear();
                
                // Check if we have valid data
                if (data && data.data && Array.isArray(data.data)) {
                    // Make sure all dates are in correct format 
                    data.data.forEach(item => {
                        // Convert start_time and end_time to actual Date objects
                        if (item.start_time) {
                            item.start_time_raw = item.start_time; // Keep original for sorting
                        }
                        if (item.end_time) {
                            item.end_time_raw = item.end_time; // Keep original for sorting
                        }
                    });
                    
                    // Add data to table
                    dataTable.rows.add(data.data).draw();
                    
                    // Re-sort by start date after drawing
                    dataTable.order([0, 'asc']).draw();
                    
                    // Show a message if no data was found
                    if (data.data.length === 0) {
                        document.getElementById('error-message').classList.remove('d-none');
                        document.getElementById('error-message').classList.add('alert-warning');
                        document.getElementById('error-message').classList.remove('alert-danger');
                        document.getElementById('error-message').textContent = 'No conversations found for the selected date range.';
                    }
                } else {
                    console.error('Unexpected data format:', data);
                    document.getElementById('error-message').classList.remove('d-none');
                    document.getElementById('error-message').textContent = 'Received invalid data format from the server.';
                }
                
                // Call the callback if provided
                if (typeof callback === 'function') {
                    callback();
                }
            })
            .catch(error => {
                console.error('Error fetching conversations:', error);
                document.getElementById('loading-indicator').classList.add('d-none');
                document.getElementById('error-message').classList.remove('d-none');
                
                // Call the callback if provided
                if (typeof callback === 'function') {
                    callback();
                }
            });
    }
    
    function viewConversation(conversationId) {
        // Store the current conversation ID
        currentConversationId = conversationId;
        
        // Clear all tab content and show loading indicators
        document.getElementById('overview-content').innerHTML = '<div class="text-center py-4"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading overview...</p></div>';
        document.getElementById('transcription-content').innerHTML = '<div class="text-center py-4"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading transcription...</p></div>';
        document.getElementById('client-data-content').innerHTML = '<div class="text-center py-4"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading client data...</p></div>';
        
        // Show the modal
        $('#conversationModal').modal('show');
        
        // Fetch conversation details
        fetch(`/api/conversations/${conversationId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Received conversation data:", data);
                
                // Format the start and end times - handle null values
                const startTime = data.start_time ? new Date(data.start_time).toLocaleString() : 'Unknown';
                const endTime = data.end_time ? new Date(data.end_time).toLocaleString() : 'Unknown';
                const duration = data.duration !== null ? data.duration : 'Unknown';
                const cost = data.cost !== undefined ? data.cost : 'Unknown';
                
                // OVERVIEW TAB
                let overviewHtml = `
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Conversation Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3">Timing</h6>
                                    <p>
                                        <i class="fas fa-calendar-alt me-2"></i><strong>Date:</strong> 
                                        ${startTime.split(',')[0]}<br>
                                        <i class="fas fa-clock me-2"></i><strong>Time:</strong> 
                                        ${startTime.split(',')[1] ? startTime.split(',')[1].trim() : 'Unknown'}<br>
                                        <i class="fas fa-hourglass-half me-2"></i><strong>Duration:</strong> 
                                        ${formatDuration(duration)}
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3">Metrics</h6>
                                    <p>
                                        <i class="fas fa-dollar-sign me-2"></i><strong>Cost (credits):</strong> 
                                        ${cost}<br>
                                        <i class="fas fa-comments me-2"></i><strong>Messages:</strong> 
                                        ${data.transcript ? data.transcript.length : 0}<br>
                                        <i class="fas fa-headset me-2"></i><strong>Channel:</strong> 
                                        ${data.channel || 'Voice Call'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add summary if available
                if (data.summary) {
                    overviewHtml += `
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Conversation Summary</h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-0">${data.summary}</p>
                            </div>
                        </div>
                    `;
                }
                
                // Add call status section
                const statusClass = getStatusClass(data.status || 'unknown');
                overviewHtml += `
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Call Status</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <span class="badge ${statusClass} p-2 me-3" style="font-size: 1rem;">${data.status || 'Unknown'}</span>
                                <div class="progress flex-grow-1" style="height: 10px;">
                                    <div class="progress-bar ${statusClass}" role="progressbar" style="width: 100%;" 
                                        aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Update the overview tab content
                document.getElementById('overview-content').innerHTML = overviewHtml;
                
                // TRANSCRIPTION TAB
                let transcriptHtml = `
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light d-flex justify-content-between">
                            <h6 class="mb-0">Conversation Transcript</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="copy-transcript">
                                <i class="fas fa-copy me-1"></i> Copy All
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="conversation-transcript p-3">
                `;
                
                // Add transcript messages if they exist
                if (data.transcript && data.transcript.length > 0) {
                    let fullTranscriptText = '';
                    
                    data.transcript.forEach((turn, index) => {
                        // Use explicit is_agent field if available, or check speaker name
                        const isAgent = turn.is_agent !== undefined ? turn.is_agent : (turn.speaker === 'Lily' || turn.speaker === 'Agent');
                        
                        // Set different background colors for agent vs user
                        const bgColor = isAgent ? 'bg-light' : 'bg-primary bg-opacity-10';
                        
                        // Set alignment based on speaker
                        const textAlign = isAgent ? 'text-start' : 'text-end';
                        
                        // Format timestamp if available
                        const timestamp = turn.timestamp ? new Date(turn.timestamp).toLocaleString() : '';
                        
                        // Use custom icon for each speaker
                        const speakerIcon = isAgent ? 
                            '<i class="fas fa-headset me-1 text-primary"></i>' : 
                            '<i class="fas fa-user me-1 text-info"></i>';
                        
                        // Add to full transcript text for copy functionality
                        fullTranscriptText += `${turn.speaker}: ${turn.text || 'No message content'}\n`;
                        
                        transcriptHtml += `
                            <div class="message ${textAlign} mb-3">
                                <div class="d-inline-block ${bgColor} p-3 rounded" style="max-width: 80%;">
                                    <div class="small text-muted mb-1">
                                        ${speakerIcon}<strong>${turn.speaker}</strong> ${timestamp ? ' - ' + timestamp : ''}
                                    </div>
                                    <div class="message-text">${turn.text || 'No message content'}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    // Store the full transcript for copying
                    window.fullTranscriptText = fullTranscriptText;
                } else {
                    transcriptHtml += `<div class="alert alert-info m-3">No transcript data available for this conversation.</div>`;
                }
                
                transcriptHtml += `
                            </div>
                        </div>
                    </div>
                `;
                
                // Update the transcription tab content
                document.getElementById('transcription-content').innerHTML = transcriptHtml;
                
                // Add event listener for copy button
                setTimeout(() => {
                    const copyBtn = document.getElementById('copy-transcript');
                    if (copyBtn) {
                        copyBtn.addEventListener('click', () => {
                            if (window.fullTranscriptText) {
                                copyToClipboard(window.fullTranscriptText);
                            }
                        });
                    }
                }, 0);
                
                // CLIENT DATA TAB
                let clientDataHtml = `
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Client Information</h6>
                        </div>
                        <div class="card-body">
                `;
                
                // Check if client_data is available in the response
                const clientData = data.client_data || {};
                const hasClientData = Object.keys(clientData).length > 0;
                
                if (hasClientData) {
                    clientDataHtml += `
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Field</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    // Display client data fields
                    for (const [key, value] of Object.entries(clientData)) {
                        // Format the key for display
                        const formattedKey = key
                            .replace(/_/g, ' ')
                            .replace(/\b\w/g, l => l.toUpperCase());
                            
                        // Handle different types of values
                        let displayValue = value;
                        if (typeof value === 'object' && value !== null) {
                            displayValue = JSON.stringify(value);
                        }
                        
                        clientDataHtml += `
                            <tr>
                                <td>${formattedKey}</td>
                                <td>${displayValue}</td>
                            </tr>
                        `;
                    }
                    
                    clientDataHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    // Fall back to metadata if client_data is empty
                    const metadata = data.metadata || {};
                    const hasMetadataClientInfo = Object.keys(metadata).some(key => 
                        key.toLowerCase().includes('client') || 
                        key.toLowerCase().includes('user') || 
                        key.toLowerCase().includes('customer')
                    );
                    
                    if (hasMetadataClientInfo) {
                        clientDataHtml += `
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Field</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        // Extract client-related fields from metadata
                        for (const [key, value] of Object.entries(metadata)) {
                            if (key.toLowerCase().includes('client') || 
                                key.toLowerCase().includes('user') || 
                                key.toLowerCase().includes('customer')) {
                                
                                // Format the key for display
                                const formattedKey = key
                                    .replace(/_/g, ' ')
                                    .replace(/\b\w/g, l => l.toUpperCase());
                                
                                // Handle different types of values
                                let displayValue = value;
                                if (typeof value === 'object' && value !== null) {
                                    displayValue = JSON.stringify(value);
                                }
                                
                                clientDataHtml += `
                                    <tr>
                                        <td>${formattedKey}</td>
                                        <td>${displayValue}</td>
                                    </tr>
                                `;
                            }
                        }
                        
                        clientDataHtml += `
                                </tbody>
                            </table>
                        </div>
                        `;
                    } else {
                        clientDataHtml += `<div class="alert alert-info">No client data available for this conversation.</div>`;
                    }
                }
                
                clientDataHtml += `
                        </div>
                    </div>
                `;
                
                // Update the client data tab content
                document.getElementById('client-data-content').innerHTML = clientDataHtml;
            })
            .catch(error => {
                console.error('Error fetching conversation details:', error);
                // Show error in all tabs
                const errorHtml = '<div class="alert alert-danger my-3">Failed to load conversation details. Please try again.</div>';
                document.getElementById('overview-content').innerHTML = errorHtml;
                document.getElementById('transcription-content').innerHTML = errorHtml;
                document.getElementById('client-data-content').innerHTML = errorHtml;
            });
    }
    
    // Helper function to format duration in seconds as minutes:seconds
    function formatDuration(seconds) {
        if (seconds === 'Unknown') return 'Unknown';
        
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')} (${seconds} seconds)`;
    }
    
    // Helper function to determine status badge class
    function getStatusClass(status) {
        status = status.toLowerCase();
        if (status === 'completed' || status === 'success' || status === 'done') {
            return 'bg-success';
        } else if (status === 'failed' || status === 'error') {
            return 'bg-danger';
        } else if (status === 'in_progress' || status === 'processing') {
            return 'bg-primary';
        } else {
            return 'bg-secondary';
        }
    }
</script>
{% endblock %} 