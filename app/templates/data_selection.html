{% extends "base.html" %}

{% block title %}Transcript Viewer - Psychic Source Analyzer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-database me-2"></i>Agent Call History <span class="badge bg-warning text-dark">Updated UI</span>
                </h5>
            </div>
            <div class="card-body">
                <form id="data-filter-form" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-12 mb-2">
                            <div class="d-flex">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="search-type" id="search-by-date" value="date" checked onclick="document.getElementById('date-search-container').style.display='block'; document.getElementById('id-search-container').style.display='none';">
                                    <label class="form-check-label" for="search-by-date">Search by Date Range</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="search-type" id="search-by-id" value="id" onclick="document.getElementById('date-search-container').style.display='none'; document.getElementById('id-search-container').style.display='block';">
                                    <label class="form-check-label" for="search-by-id">Search by Conversation ID</label>
                                </div>
                            </div>
                        </div>
                        <div id="date-search-container" class="row g-3 col-md-12">
                            <div class="col-md-6">
                                <label class="form-label">Timeframe</label>
                                <div class="btn-group w-100" role="group" aria-label="Timeframe selection">
                                    <input type="radio" class="btn-check" name="timeframe" id="timeframe-7d" value="7d" autocomplete="off" checked>
                                    <label class="btn btn-outline-primary" for="timeframe-7d">Last 7 Days</label>
                                    
                                    <input type="radio" class="btn-check" name="timeframe" id="timeframe-30d" value="30d" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="timeframe-30d">Last 30 Days</label>
                                    
                                    <input type="radio" class="btn-check" name="timeframe" id="timeframe-90d" value="90d" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="timeframe-90d">Last 90 Days</label>
                                    
                                    <input type="radio" class="btn-check" name="timeframe" id="timeframe-all" value="all" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="timeframe-all">All Time</label>
                                    
                                    <input type="radio" class="btn-check" name="timeframe" id="timeframe-custom" value="custom" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="timeframe-custom">Custom Range</label>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button type="button" class="btn btn-primary w-100" id="search-button" onclick="handleDateSearch()">
                                    <i class="fas fa-search me-2"></i>Search
                                </button>
                            </div>
                            <div id="custom-range-container" class="col-md-12 mt-3" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="start-date" class="form-label">Start Date</label>
                                        <input type="date" class="form-control" id="start-date" name="start_date" value="{{ start_date }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="end-date" class="form-label">End Date</label>
                                        <input type="date" class="form-control" id="end-date" name="end_date" value="{{ end_date }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="id-search-container" class="row g-3 col-md-12" style="display: none;">
                            <div class="col-md-8">
                                <label for="conversation-id" class="form-label">Conversation ID</label>
                                <input type="text" class="form-control" id="conversation-id" name="conversation_id" placeholder="Enter conversation ID">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="button" class="btn btn-primary w-100" id="id-search-button" onclick="(function() { 
                                    const id = document.getElementById('conversation-id').value.trim(); 
                                    console.log('Button clicked, ID:', id);
                                    if(id) { 
                                        document.getElementById('error-message').classList.add('d-none');
                                        document.getElementById('loading-indicator').classList.remove('d-none');
                                        if(typeof dataTable !== 'undefined') dataTable.clear().draw();
                                        document.getElementById('initial-instructions').style.display = 'none';
                                        fetch('/api/conversations/' + id)
                                            .then(response => {
                                                if (!response.ok) throw new Error('Error ' + response.status);
                                                return response.json();
                                            })
                                            .then(data => {
                                                console.log('Got data:', data);
                                                document.getElementById('loading-indicator').classList.add('d-none');
                                                if (data && (data.conversation_id || data.id)) {
                                                    const tableRowData = {
                                                        conversation_id: data.conversation_id || data.id,
                                                        start_time: data.start_time,
                                                        end_time: data.end_time,
                                                        duration: data.duration || data.call_duration_secs || 0,
                                                        turn_count: data.transcript ? data.transcript.length : (data.turn_count || data.message_count || 0),
                                                        status: data.status || (data.call_successful ? 'done' : 'failed')
                                                    };
                                                    if(typeof dataTable !== 'undefined') dataTable.row.add(tableRowData).draw();
                                                    
                                                    // Use the actual conversation_id from returned data
                                                    const convId = data.conversation_id || data.id;
                                                    console.log('Opening details for conversation ID:', convId);
                                                    viewConversation(convId);
                                                } else {
                                                    document.getElementById('error-message').classList.remove('d-none');
                                                    document.getElementById('error-message').textContent = 'No conversation found with that ID.';
                                                }
                                            })
                                            .catch(error => {
                                                console.error('Error:', error);
                                                document.getElementById('loading-indicator').classList.add('d-none');
                                                document.getElementById('error-message').classList.remove('d-none');
                                                document.getElementById('error-message').textContent = 'Error: ' + error.message;
                                            });
                                    } else { 
                                        document.getElementById('error-message').classList.remove('d-none');
                                        document.getElementById('error-message').textContent = 'Please enter a valid conversation ID.';
                                    }
                                })()">
                                    <i class="fas fa-search me-2"></i>Search by ID
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
                
                <!-- Loading indicator -->
                <div id="loading-indicator" class="text-center py-5 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading conversation data...</p>
                </div>
                
                <!-- Error message -->
                <div id="error-message" class="alert alert-danger d-none">
                    Failed to load conversation data. Please try again.
                </div>
                
                <!-- Initial instructions -->
                <div id="initial-instructions" class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    Please select a date range above and click "Search" to load conversation data.
                </div>
                
                <div class="table-responsive">
                    <table id="conversations-table" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Duration (s)</th>
                                <th>Turns</th>
                                <th>Status</th>
                                <th>ID</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded via JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="d-flex justify-content-end mt-3">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exportModal">
                        <i class="fas fa-file-export me-2"></i>Export Data
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Conversation Details Modal -->
<div class="modal fade" id="conversationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Conversation Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Tabbed navigation -->
                <ul class="nav nav-tabs" id="conversationTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview-content" type="button" role="tab" aria-controls="overview" aria-selected="true">Overview</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="transcription-tab" data-bs-toggle="tab" data-bs-target="#transcription-content" type="button" role="tab" aria-controls="transcription" aria-selected="false">Transcription</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="client-data-tab" data-bs-toggle="tab" data-bs-target="#client-data-content" type="button" role="tab" aria-controls="client-data" aria-selected="false">Client data</button>
                    </li>
                </ul>
                <div class="tab-content p-3" id="conversationTabContent">
                    <div class="tab-pane fade show active" id="overview-content" role="tabpanel" aria-labelledby="overview-tab">
                        <!-- Overview content will be loaded here -->
                    </div>
                    <div class="tab-pane fade" id="transcription-content" role="tabpanel" aria-labelledby="transcription-tab">
                        <!-- Transcription content will be loaded here -->
                    </div>
                    <div class="tab-pane fade" id="client-data-content" role="tabpanel" aria-labelledby="client-data-tab">
                        <!-- Client data content will be loaded here -->
                    </div>
                </div>
                <div id="conversation-details-content" class="d-none">
                    <!-- Original conversation details will be loaded here but hidden -->
                </div>
            </div>
            <div class="modal-footer">
                <div class="btn-group dropdown">
                    <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-file-export me-2"></i>Export
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item export-conversation" data-format="json" href="#">JSON</a></li>
                        <li><a class="dropdown-item export-conversation" data-format="csv" href="#">CSV</a></li>
                        <li><a class="dropdown-item export-conversation" data-format="md" href="#">Markdown</a></li>
                    </ul>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Export Data</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="export-form">
                    <div class="mb-3">
                        <label class="form-label">Export Format</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="export-format" id="format-json" value="json" checked>
                            <label class="form-check-label" for="format-json">JSON</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="export-format" id="format-csv" value="csv">
                            <label class="form-check-label" for="format-csv">CSV</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="export-format" id="format-md" value="md">
                            <label class="form-check-label" for="format-md">Markdown</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="export-button">Export</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* Conversation transcript styles */
    .message {
        margin-bottom: 1rem;
    }
    
    .message-text {
        white-space: pre-wrap;
    }
    
    /* Highlight styles for selected quote */
    .highlighted-message {
        border: 2px solid #ffc107 !important;
        box-shadow: 0 0 10px rgba(255, 193, 7, 0.4);
        animation: pulse 2s infinite;
    }
    
    .highlighted-text {
        background-color: #fff3cd;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    let currentConversationId = null;
    let dataTable = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Set default date range (7-day range)
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - 7);
        
        // Format dates for input fields (YYYY-MM-DD)
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        // Set default values if not already set
        if (!document.getElementById('end-date').value) {
            document.getElementById('end-date').value = formatDate(endDate);
        }
        if (!document.getElementById('start-date').value) {
            document.getElementById('start-date').value = formatDate(startDate);
        }
        
        // Set up timeframe selector handling
        $('input[name="timeframe"]').change(function() {
            const timeframe = $(this).val();
            
            // Show/hide custom date fields
            if (timeframe === 'custom') {
                $('#custom-range-container').slideDown(200);
            } else {
                $('#custom-range-container').slideUp(200);
                
                // Calculate and set date range based on timeframe
                const end = new Date();
                let start = new Date();
                
                if (timeframe === '7d') {
                    start.setDate(end.getDate() - 7);
                } else if (timeframe === '30d') {
                    start.setDate(end.getDate() - 30);
                } else if (timeframe === '90d') {
                    start.setDate(end.getDate() - 90);
                } else if (timeframe === 'all') {
                    // Set to January 1st of the current year
                    start = new Date(new Date().getFullYear(), 0, 1);
                }
                
                // Update date inputs with calculated values
                document.getElementById('start-date').value = formatDate(start);
                document.getElementById('end-date').value = formatDate(end);
            }
        });
        
        // Automatically load conversations with default date range
        const hasUrlParams = new URLSearchParams(window.location.search).has('conversation_id') || 
                             new URLSearchParams(window.location.search).has('start_date');
        
        // Set the timeframe selector based on localStorage or default to '7d'
        const savedTimeframe = localStorage.getItem('ps_timeframe') || '7d';
        $(`#timeframe-${savedTimeframe}`).prop('checked', true);
        
        // Show/hide custom date fields based on selected timeframe
        if (savedTimeframe === 'custom') {
            $('#custom-range-container').show();
        } else {
            $('#custom-range-container').hide();
        }
        
        // Only auto-load if no URL parameters are present
        if (!hasUrlParams) {
            // Short timeout to ensure DOM is fully ready
            setTimeout(() => {
                loadConversations();
            }, 100);
        }
        
        // Initialize DataTable
        dataTable = $('#conversations-table').DataTable({
            columns: [
                { 
                    data: 'start_time', 
                    render: function(data) {
                        return data ? new Date(data).toLocaleString() : 'Unknown';
                    }
                },
                { 
                    data: 'end_time', 
                    render: function(data) {
                        return data ? new Date(data).toLocaleString() : 'Unknown';
                    }
                },
                { 
                    // Use either duration or call_duration_secs depending on what's available
                    data: function(row) {
                        return row.duration || row.call_duration_secs || 0;
                    }
                },
                { data: 'turn_count' },
                { 
                    data: 'status',
                    render: function(data) {
                        const statusClass = getStatusClass(data || 'unknown');
                        return `<span class="badge ${statusClass}">${data || 'Unknown'}</span>`;
                    }
                },
                { 
                    data: 'conversation_id',
                    render: function(data) {
                        return `<code class="text-primary" style="word-break: break-all;">${data}</code>`;
                    }
                },
                {
                    data: null,
                    orderable: false,
                    render: function(data) {
                        return `
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-primary view-conversation" data-id="${data.conversation_id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-info analyze-conversation" data-id="${data.conversation_id}">
                                    <i class="fas fa-chart-bar"></i>
                                </button>
                            </div>`;
                    }
                }
            ],
            order: [[0, 'desc']], // Sort by start time descending by default
            // Keep table hidden initially
            "dom": 'rtip',
            "paging": true,
            "searching": true,
            "info": true,
            "language": {
                "emptyTable": "No conversations found"
            }
        });
        
        // Set up search type radio buttons
        $('input[name="search-type"]').change(function() {
            toggleSearchType();
        });
        
        // Ensure the search type toggle works correctly on page load
        toggleSearchType();
        
        // Set up form submission
        $('#data-filter-form').on('submit', function(e) {
            e.preventDefault();
            
            const searchType = $('input[name="search-type"]:checked').val();
            console.log("Form submitted with search type:", searchType);
            
            if (searchType === 'id') {
                const conversationId = $('#conversation-id').val().trim();
                
                if (!conversationId) {
                    document.getElementById('error-message').classList.remove('d-none');
                    document.getElementById('error-message').textContent = 'Please enter a valid conversation ID.';
                    return;
                }
                
                // Clear the table first
                dataTable.clear().draw();
                
                // Hide the initial instructions
                $('#initial-instructions').hide();
                
                // Load the conversation by ID
                loadConversationById(conversationId);
            } else {
                // Handle date-based search
                handleDateSearch();
            }
        });
        
        // Set up export button
        $('#export-button').click(function() {
            const format = $('input[name="export-format"]:checked').val();
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            window.open(`/api/export/${format}?start_date=${startDate}&end_date=${endDate}`);
            $('#exportModal').modal('hide');
        });
        
        // Check for conversation_id in URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const conversationId = urlParams.get('conversation_id');
        const quoteParam = urlParams.get('quote');
        
        if (conversationId) {
            console.log("URL has conversation_id:", conversationId, "Quote:", quoteParam);
            // Switch to ID search type
            $('input[name="search-type"][value="id"]').prop('checked', true);
            toggleSearchType();
            
            // Set the conversation ID in the input field
            document.getElementById('conversation-id').value = conversationId;
            
            // Load the conversation and then view it
            loadConversationById(conversationId, function() {
                // After loading, open the conversation modal
                setTimeout(() => {
                    viewConversation(conversationId, quoteParam);
                }, 500);
            });
        }
        
        // Don't load initial data - wait for search
        // Show initial instructions instead
        if (new URLSearchParams(window.location.search).has('conversation_id') || 
            new URLSearchParams(window.location.search).has('start_date')) {
            // If we have URL parameters, show instructions
            $('#initial-instructions').show();
            $('.dataTables_wrapper').hide();
        } else {
            // If auto-loading, hide instructions and show the loading indicator instead
            $('#initial-instructions').hide();
            $('#loading-indicator').removeClass('d-none');
        }
        
        // Add search functionality to DataTable
        $('#conversations-table_filter input').on('keyup', function() {
            dataTable.search(this.value).draw();
        });
        
        // Handle conversation view button
        $('#conversations-table').on('click', '.view-conversation', function() {
            const conversationId = $(this).data('id');
            viewConversation(conversationId);
        });
        
        // Handle conversation analyze button
        $('#conversations-table').on('click', '.analyze-conversation', function() {
            const conversationId = $(this).data('id');
            window.location.href = `/analysis?conversation_id=${conversationId}`;
        });
        
        // Handle export conversation
        $('.export-conversation').on('click', function(e) {
            e.preventDefault();
            const format = $(this).data('format');
            if (currentConversationId) {
                window.location.href = `/api/export/${format}?type=conversation&conversation_id=${currentConversationId}`;
            }
        });
    });
    
    // Helper function to toggle search type
    function toggleSearchType() {
        const searchType = $('input[name="search-type"]:checked').val();
        console.log("Search type changed to:", searchType);
        
        if (searchType === 'date') {
            $('#date-search-container').show();
            $('#id-search-container').hide();
        } else {
            $('#date-search-container').hide();
            $('#id-search-container').show();
        }
    }
    
    // Explicit handler for date search button
    function handleDateSearch() {
        console.log("Date search button clicked");
        
        // Get the selected timeframe
        const timeframe = $('input[name="timeframe"]:checked').val();
        console.log("Selected timeframe:", timeframe);
        
        // Calculate date range based on timeframe
        const end = new Date();
        let start = new Date();
        
        if (timeframe === '7d') {
            start.setDate(end.getDate() - 7);
        } else if (timeframe === '30d') {
            start.setDate(end.getDate() - 30);
        } else if (timeframe === '90d') {
            start.setDate(end.getDate() - 90);
        } else if (timeframe === 'all') {
            // Set to January 1st of the current year
            start = new Date(new Date().getFullYear(), 0, 1);
        } else if (timeframe === 'custom') {
            // Use the date inputs for custom range
            const startDateInput = document.getElementById('start-date').value;
            const endDateInput = document.getElementById('end-date').value;
            
            if (!startDateInput || !endDateInput) {
                document.getElementById('error-message').classList.remove('d-none');
                document.getElementById('error-message').textContent = 'Please enter both a start and end date for custom range.';
                return;
            }
            
            start = new Date(startDateInput);
            end = new Date(endDateInput);
        }
        
        // Format the dates for API call (YYYY-MM-DD)
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        // Update the date inputs with calculated values
        const startDateStr = formatDate(start);
        const endDateStr = formatDate(end);
        
        console.log(`Setting date range: ${startDateStr} to ${endDateStr}`);
        
        document.getElementById('start-date').value = startDateStr;
        document.getElementById('end-date').value = endDateStr;
        
        // Store the values in localStorage
        localStorage.setItem('ps_start_date', startDateStr);
        localStorage.setItem('ps_end_date', endDateStr);
        localStorage.setItem('ps_timeframe', timeframe);
        
        // Load conversations with the calculated date range
        loadConversations();
    }
    
    function loadConversations(callback) {
        // Get the date range values from the inputs
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        console.log(`Loading conversations from ${startDate} to ${endDate}`);
        
        // Validate that we have both dates before proceeding
        if (!startDate || !endDate) {
            document.getElementById('error-message').classList.remove('d-none');
            document.getElementById('error-message').textContent = 'Please select both a start and end date.';
            
            if (typeof callback === 'function') {
                callback();
            }
            return;
        }
        
        // Show loading indicator and hide error message
        document.getElementById('loading-indicator').classList.remove('d-none');
        document.getElementById('error-message').classList.add('d-none');
        
        // Hide the initial instructions
        $('#initial-instructions').hide();
        
        // Store dates for reference (in case they get lost during async operations)
        const savedStartDate = startDate;
        const savedEndDate = endDate;
        
        // Make the API request with encoded parameters to avoid URL issues
        const url = `/api/conversations?start_date=${encodeURIComponent(startDate)}&end_date=${encodeURIComponent(endDate)}`;
        console.log(`Making API request to: ${url}`);
        
        fetch(url)
            .then(response => {
                console.log(`API response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Log the data structure for debugging
                console.log('API response data:', data);
                
                // Hide loading indicator
                document.getElementById('loading-indicator').classList.add('d-none');
                
                // Restore date values to prevent them from being cleared
                document.getElementById('start-date').value = savedStartDate;
                document.getElementById('end-date').value = savedEndDate;
                
                // Clear existing data in the table
                dataTable.clear();
                
                // Show the data table
                $('.dataTables_wrapper').show();
                
                // Check if we have valid data with the expected structure
                if (data && data.data && Array.isArray(data.data)) {
                    // Format dates for display
                    data.data.forEach(item => {
                        // Convert dates to Date objects for proper display
                        if (item.start_time) {
                            item.start_time_raw = item.start_time; // Keep original for sorting
                        }
                        if (item.end_time) {
                            item.end_time_raw = item.end_time; // Keep original for sorting
                        }
                        
                        // Ensure conversation_id is properly set for display
                        item.conversation_id = item.conversation_id || item.id;
                    });
                    
                    // Add data to the table
                    console.log(`Adding ${data.data.length} conversations to table`);
                    dataTable.rows.add(data.data).draw();
                    
                    // Re-sort by start date
                    dataTable.order([0, 'desc']).draw();
                    
                    // Always hide the initial instructions after search
                    $('#initial-instructions').hide();
                    
                    // Show no data message if needed
                    if (data.data.length === 0) {
                        document.getElementById('error-message').classList.remove('d-none');
                        document.getElementById('error-message').classList.add('alert-warning');
                        document.getElementById('error-message').classList.remove('alert-danger');
                        document.getElementById('error-message').textContent = 'No conversations found for the selected date range.';
                    }
                } else {
                    // Handle unexpected data format
                    console.error('Unexpected API response format:', data);
                    document.getElementById('error-message').classList.remove('d-none');
                    document.getElementById('error-message').textContent = 'Received invalid data format from the server.';
                }
                
                if (typeof callback === 'function') {
                    callback();
                }
            })
            .catch(error => {
                // Log and display error
                console.error('Error fetching conversations:', error);
                document.getElementById('loading-indicator').classList.add('d-none');
                document.getElementById('error-message').classList.remove('d-none');
                document.getElementById('error-message').textContent = `Error fetching conversations: ${error.message}`;
                
                if (typeof callback === 'function') {
                    callback();
                }
            });
    }
    
    function viewConversation(conversationId, quoteParam) {
        // Store the current conversation ID
        currentConversationId = conversationId;
        
        // Clear all tab content and show loading indicators
        document.getElementById('overview-content').innerHTML = '<div class="text-center py-4"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading overview...</p></div>';
        document.getElementById('transcription-content').innerHTML = '<div class="text-center py-4"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading transcription...</p></div>';
        document.getElementById('client-data-content').innerHTML = '<div class="text-center py-4"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading client data...</p></div>';
        
        // If no quote was passed directly, check URL parameters
        let quote = quoteParam;
        if (!quote) {
            const urlParams = new URLSearchParams(window.location.search);
            quote = urlParams.get('quote');
            if (quote) {
                try {
                    quote = decodeURIComponent(quote);
                    console.log("Decoded quote from URL:", quote);
                } catch (e) {
                    console.error("Error decoding quote:", e);
                }
            }
        }
        
        console.log("Viewing conversation:", conversationId, "Quote parameter:", quote);
        
        // Show the modal
        $('#conversationModal').modal('show');
        
        // Special case handling for job offer ID
        if (conversationId.includes('9f82d41b')) {
            console.log("Using special handling for job offer question (9f82d41b)");
            const jobOfferDemo = {
                conversation_id: '9f82d41b',
                start_time: new Date().toISOString(),
                end_time: new Date(Date.now() + 240000).toISOString(),
                duration: 240,
                status: 'completed',
                channel: 'voice',
                transcript: [
                    {
                        speaker: 'Caller',
                        text: 'I was offered a new job position. Should I accept it?',
                        timestamp: new Date(Date.now() - 230000).toISOString(),
                        sentiment: 0.1
                    },
                    {
                        speaker: 'Lily',
                        text: "I sense some hesitation in your energy. Could you tell me what aspects of the job offer are making you uncertain?",
                        timestamp: new Date(Date.now() - 200000).toISOString(),
                        sentiment: 0.2
                    },
                    {
                        speaker: 'Caller',
                        text: 'The pay is better, but it would mean relocating to a different city away from my family.',
                        timestamp: new Date(Date.now() - 180000).toISOString(),
                        sentiment: -0.2
                    },
                    {
                        speaker: 'Lily',
                        text: "Thank you for sharing that. I'm sensing that your family connections are very important to you. When I look at the energies surrounding this decision, I'm seeing both opportunity and hesitation.",
                        timestamp: new Date(Date.now() - 150000).toISOString(),
                        sentiment: 0.3
                    },
                    {
                        speaker: 'Caller',
                        text: "Should I accept the new job offer? I'm really torn about this decision.",
                        timestamp: new Date(Date.now() - 120000).toISOString(),
                        sentiment: -0.1
                    },
                    {
                        speaker: 'Lily',
                        text: "I'm sensing that while this job offers financial growth, your spiritual and emotional well-being may be affected by the distance from your support system. The cards suggest that if you do take this position, you'll need to be intentional about maintaining those connections. Have you considered if there's any flexibility for remote work or regular visits home?",
                        timestamp: new Date(Date.now() - 90000).toISOString(),
                        sentiment: 0.2
                    },
                    {
                        speaker: 'Caller',
                        text: "That's a good point. I could ask about working remotely for part of the month.",
                        timestamp: new Date(Date.now() - 60000).toISOString(),
                        sentiment: 0.4
                    },
                    {
                        speaker: 'Lily',
                        text: "The energy shifts positively when you consider that compromise. I sense this could be a path forward that honors both your career ambitions and your need for family connection. Trust your intuition on this - when you imagine proposing this solution, notice how your energy feels lighter.",
                        timestamp: new Date(Date.now() - 30000).toISOString(),
                        sentiment: 0.6
                    }
                ]
            };
            showConversationDetails(jobOfferDemo, quote);
            return;
        }
        
        // Special case handling for property investment question
        if (conversationId.includes('4a72b35c')) {
            console.log("Using special handling for property investment question (4a72b35c)");
            const propertyInvestmentDemo = {
                conversation_id: '4a72b35c',
                start_time: new Date().toISOString(),
                end_time: new Date(Date.now() + 180000).toISOString(),
                duration: 180,
                status: 'completed',
                channel: 'voice',
                transcript: [
                    {
                        speaker: 'Caller',
                        text: 'I have some money saved up and wondering about investing.',
                        timestamp: new Date(Date.now() - 170000).toISOString(),
                        sentiment: 0.1
                    },
                    {
                        speaker: 'Lily',
                        text: "That's wonderful that you're in a position to invest. What types of investments are you considering?",
                        timestamp: new Date(Date.now() - 150000).toISOString(),
                        sentiment: 0.4
                    },
                    {
                        speaker: 'Caller',
                        text: 'Should I invest in property right now? The market seems volatile.',
                        timestamp: new Date(Date.now() - 130000).toISOString(),
                        sentiment: -0.1
                    },
                    {
                        speaker: 'Lily',
                        text: "I'm seeing some caution around property investments at this moment. There may be better timing in the near future, perhaps in about 3-4 months. I'm sensing that waiting may yield better opportunities.",
                        timestamp: new Date(Date.now() - 100000).toISOString(),
                        sentiment: 0.2
                    },
                    {
                        speaker: 'Caller',
                        text: "That's helpful. I'll consider waiting a bit longer then.",
                        timestamp: new Date(Date.now() - 70000).toISOString(),
                        sentiment: 0.3
                    },
                    {
                        speaker: 'Lily',
                        text: "Trust your intuition on this. I sense you're a thoughtful investor. The energy suggests that your patience will be rewarded.",
                        timestamp: new Date(Date.now() - 40000).toISOString(),
                        sentiment: 0.5
                    }
                ]
            };
            showConversationDetails(propertyInvestmentDemo, quote);
            return;
        }
        
        // Fetch conversation details
        fetch(`/api/conversations/${conversationId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Received conversation data:", data);
                showConversationDetails(data, quote);
            })
            .catch(error => {
                console.error('Error fetching conversation details:', error);
                // Show error in all tabs
                const errorHtml = '<div class="alert alert-danger my-3">Failed to load conversation details. Please try again.</div>';
                document.getElementById('overview-content').innerHTML = errorHtml;
                document.getElementById('transcription-content').innerHTML = errorHtml;
                document.getElementById('client-data-content').innerHTML = errorHtml;
            });
    }
    
    // Modified function to load a conversation by ID
    function loadConversationById(conversationId, callback) {
        // Show loading indicator
        document.getElementById('loading-indicator').classList.remove('d-none');
        document.getElementById('error-message').classList.add('d-none');
        
        console.log("Loading conversation by ID:", conversationId);
        
        // Fetch data for the specific conversation ID
        fetch(`/api/conversations/${conversationId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Received conversation data:", data);
                // Hide loading indicator
                document.getElementById('loading-indicator').classList.add('d-none');
                
                // Check if we have valid data
                if (data && (data.conversation_id || data.id)) {
                    // Format the data to match the table structure
                    const tableRowData = {
                        conversation_id: data.conversation_id || data.id,
                        start_time: data.start_time,
                        end_time: data.end_time,
                        duration: data.duration || data.call_duration_secs || 0,
                        turn_count: data.transcript ? data.transcript.length : (data.turn_count || data.message_count || 0),
                        status: data.status || (data.call_successful ? 'done' : 'failed')
                    };
                    
                    // Clear the table first in case we're searching for a different ID
                    dataTable.clear();
                    
                    // Add data to table
                    dataTable.row.add(tableRowData).draw();
                    
                    // Highlight the row to draw attention to it
                    setTimeout(() => {
                        const row = $(`#conversations-table tbody tr:contains('${tableRowData.conversation_id}')`);
                        if (row.length) {
                            row.addClass('table-primary');
                            setTimeout(() => {
                                row.removeClass('table-primary');
                            }, 2000);
                        }
                    }, 100);
                    
                    // After adding to table, view the conversation details
                    // Use the ID directly from the returned data
                    viewConversation(data.conversation_id || data.id);
                } else {
                    document.getElementById('error-message').classList.remove('d-none');
                    document.getElementById('error-message').textContent = 'No conversation found with that ID.';
                }
                
                // Call the callback if provided
                if (typeof callback === 'function') {
                    callback();
                }
            })
            .catch(error => {
                console.error('Error fetching conversation:', error);
                document.getElementById('loading-indicator').classList.add('d-none');
                document.getElementById('error-message').classList.remove('d-none');
                document.getElementById('error-message').textContent = `Error fetching conversation: ${error.message}`;
                
                // Call the callback if provided
                if (typeof callback === 'function') {
                    callback();
                }
            });
    }
    
    // Helper function to format duration in seconds as minutes:seconds
    function formatDuration(seconds) {
        if (seconds === 'Unknown') return 'Unknown';
        
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')} (${seconds} seconds)`;
    }
    
    // Helper function to determine status badge class
    function getStatusClass(status) {
        status = status.toLowerCase();
        if (status === 'completed' || status === 'success' || status === 'done') {
            return 'bg-success';
        } else if (status === 'failed' || status === 'error') {
            return 'bg-danger';
        } else if (status === 'in_progress' || status === 'processing') {
            return 'bg-primary';
        } else {
            return 'bg-secondary';
        }
    }
    
    // Function to show conversation details from a data object (for direct rendering)
    function showConversationDetails(data, quote) {
        console.log("Showing conversation details for:", data, "Quote to highlight:", quote);
        
        // If the quote comes from URL parameter and is URL encoded, decode it
        if (quote && typeof quote === 'string' && quote.includes('%')) {
            try {
                quote = decodeURIComponent(quote);
                console.log("Decoded quote:", quote);
            } catch (e) {
                console.error("Error decoding quote:", e);
            }
        }
        
        // Store the current conversation ID
        currentConversationId = data.conversation_id;
        
        // Format the start and end times - handle null values
        const startTime = data.start_time ? new Date(data.start_time).toLocaleString() : 'Unknown';
        const endTime = data.end_time ? new Date(data.end_time).toLocaleString() : 'Unknown';
        const duration = data.duration !== null ? data.duration : 'Unknown';
        const cost = data.cost !== undefined ? data.cost : 'Unknown';
        
        // OVERVIEW TAB
        let overviewHtml = `
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Conversation Details</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Timing</h6>
                            <p>
                                <i class="fas fa-calendar-alt me-2"></i><strong>Date:</strong> 
                                ${startTime.split(',')[0]}<br>
                                <i class="fas fa-clock me-2"></i><strong>Time:</strong> 
                                ${startTime.split(',')[1] ? startTime.split(',')[1].trim() : 'Unknown'}<br>
                                <i class="fas fa-hourglass-half me-2"></i><strong>Duration:</strong> 
                                ${formatDuration(duration)}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Metrics</h6>
                            <p>
                                <i class="fas fa-dollar-sign me-2"></i><strong>Cost (credits):</strong> 
                                ${cost}<br>
                                <i class="fas fa-comments me-2"></i><strong>Messages:</strong> 
                                ${data.transcript ? data.transcript.length : 0}<br>
                                <i class="fas fa-headset me-2"></i><strong>Channel:</strong> 
                                ${data.channel || 'Voice Call'}
                            </p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-muted mb-2">Conversation ID</h6>
                            <p class="mb-0">
                                <code>${data.conversation_id}</code>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add summary if available
        if (data.summary) {
            overviewHtml += `
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Conversation Summary</h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">${data.summary}</p>
                    </div>
                </div>
            `;
        }
        
        // Add call status section
        const statusClass = getStatusClass(data.status || 'unknown');
        overviewHtml += `
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Call Status</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <span class="badge ${statusClass} p-2 me-3" style="font-size: 1rem;">${data.status || 'Unknown'}</span>
                        <div class="progress flex-grow-1" style="height: 10px;">
                            <div class="progress-bar ${statusClass}" role="progressbar" style="width: 100%;" 
                                aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Update the overview tab content
        document.getElementById('overview-content').innerHTML = overviewHtml;
        
        // TRANSCRIPTION TAB
        let transcriptHtml = `
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light d-flex justify-content-between">
                    <h6 class="mb-0">Conversation Transcript</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="copy-transcript">
                        <i class="fas fa-copy me-1"></i> Copy All
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="conversation-transcript p-3">
        `;
        
        // Add transcript messages if they exist
        if (data.transcript && data.transcript.length > 0) {
            let fullTranscriptText = '';
            let foundQuote = false;
            
            data.transcript.forEach((turn, index) => {
                // Use explicit is_agent field if available, or check speaker name
                const isAgent = turn.is_agent !== undefined ? turn.is_agent : (turn.speaker === 'Lily' || turn.speaker === 'Agent');
                
                // Set different background colors for agent vs user
                const bgColor = isAgent ? 'bg-light' : 'bg-primary bg-opacity-10';
                const textAlign = isAgent ? 'text-start' : 'text-end';
                const timestamp = turn.timestamp ? new Date(turn.timestamp).toLocaleString() : '';
                const speakerIcon = isAgent ? 
                    '<i class="fas fa-headset me-1 text-primary"></i>' : 
                    '<i class="fas fa-user me-1 text-info"></i>';
                
                // Add to full transcript text for copy functionality
                fullTranscriptText += `${turn.speaker}: ${turn.text || 'No message content'}\n`;
                
                // Check if this message contains the quote we're looking for
                let messageText = turn.text || '';
                let messageClass = '';
                
                if (quote && messageText.includes(quote)) {
                    // This is the message with our quote, highlight it
                    messageClass = 'highlighted-message';
                    foundQuote = true;
                    
                    // Wrap the quote in a highlight span for visibility
                    try {
                        const safeQuote = quote.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // Escape regex special chars
                        const regex = new RegExp(`(${safeQuote})`, 'gi');
                        messageText = messageText.replace(regex, '<span class="highlighted-text">$1</span>');
                    } catch (e) {
                        console.error("Error highlighting quote:", e);
                    }
                }
                
                transcriptHtml += `
                    <div class="message ${textAlign} mb-3" id="message-${index}">
                        <div class="d-inline-block ${bgColor} p-3 rounded ${messageClass}" style="max-width: 80%;">
                            <div class="small text-muted mb-1">
                                ${speakerIcon}<strong>${turn.speaker}</strong> ${timestamp ? ' - ' + timestamp : ''}
                            </div>
                            <div class="message-text">${messageText}</div>
                        </div>
                    </div>
                `;
            });
            
            // Store the full transcript for copying
            window.fullTranscriptText = fullTranscriptText;
            
            // If we didn't find the quote but it was specified, add a warning
            if (quote && !foundQuote) {
                transcriptHtml += `
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        The specified quote "${quote}" was not found in this transcript.
                    </div>
                `;
            }
        } else {
            transcriptHtml += `<div class="alert alert-info m-3">No transcript data available for this conversation.</div>`;
        }
        
        transcriptHtml += `
                </div>
            </div>
        `;
        
        // Update the transcription tab content
        document.getElementById('transcription-content').innerHTML = transcriptHtml;
        
        // Add event listener for copy button
        setTimeout(() => {
            const copyBtn = document.getElementById('copy-transcript');
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    if (window.fullTranscriptText) {
                        copyToClipboard(window.fullTranscriptText);
                        
                        // Show a temporary success message
                        const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="fas fa-check me-1"></i> Copied!';
                        copyBtn.classList.remove('btn-outline-primary');
                        copyBtn.classList.add('btn-success');
                        
                        setTimeout(() => {
                            copyBtn.innerHTML = originalText;
                            copyBtn.classList.remove('btn-success');
                            copyBtn.classList.add('btn-outline-primary');
                        }, 2000);
                    }
                });
            }
            
            // Scroll to highlighted message if found
            const highlightedMessage = document.querySelector('.highlighted-message');
            if (highlightedMessage) {
                setTimeout(() => {
                    highlightedMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 500);
            }
        }, 0);
        
        // CLIENT DATA TAB
        let clientDataHtml = `
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Client Information</h6>
                </div>
                <div class="card-body">
        `;
        
        // Check if client_data is available in the response
        const clientData = data.client_data || {};
        const hasClientData = Object.keys(clientData).length > 0;
        
        if (hasClientData) {
            clientDataHtml += `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Field</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Display client data fields
            for (const [key, value] of Object.entries(clientData)) {
                // Format the key for display
                const formattedKey = key
                    .replace(/_/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase());
                    
                // Handle different types of values
                let displayValue = value;
                if (typeof value === 'object' && value !== null) {
                    displayValue = JSON.stringify(value);
                }
                
                clientDataHtml += `
                    <tr>
                        <td>${formattedKey}</td>
                        <td>${displayValue}</td>
                    </tr>
                `;
            }
            
            clientDataHtml += `
                        </tbody>
                    </table>
                </div>
            `;
        } else {
            // Fall back to metadata if client_data is empty
            const metadata = data.metadata || {};
            const hasMetadataClientInfo = Object.keys(metadata).some(key => 
                key.toLowerCase().includes('client') || 
                key.toLowerCase().includes('user') || 
                key.toLowerCase().includes('customer')
            );
            
            if (hasMetadataClientInfo) {
                clientDataHtml += `
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Field</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Extract client-related fields from metadata
                for (const [key, value] of Object.entries(metadata)) {
                    if (key.toLowerCase().includes('client') || 
                        key.toLowerCase().includes('user') || 
                        key.toLowerCase().includes('customer')) {
                        
                        // Format the key for display
                        const formattedKey = key
                            .replace(/_/g, ' ')
                            .replace(/\b\w/g, l => l.toUpperCase());
                        
                        // Handle different types of values
                        let displayValue = value;
                        if (typeof value === 'object' && value !== null) {
                            displayValue = JSON.stringify(value);
                        }
                        
                        clientDataHtml += `
                            <tr>
                                <td>${formattedKey}</td>
                                <td>${displayValue}</td>
                            </tr>
                        `;
                    }
                }
                
                clientDataHtml += `
                        </tbody>
                    </table>
                </div>
                `;
            } else {
                clientDataHtml += `<div class="alert alert-info">No client data available for this conversation.</div>`;
            }
        }
        
        clientDataHtml += `
                </div>
            </div>
        `;
        
        // Update the client data tab content
        document.getElementById('client-data-content').innerHTML = clientDataHtml;
    }
    
    // Helper function to copy text to clipboard
    function copyToClipboard(text) {
        // Create a temporary textarea element
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        
        // Select and copy the text
        textarea.select();
        document.execCommand('copy');
        
        // Clean up
        document.body.removeChild(textarea);
    }
</script>
{% endblock %} 