{% extends "base.html" %}

{% block title %}Themes & Sentiment - Psychic Source Analyzer{% endblock %}

{% block styles %}
<style>
    /* Custom badge colors for theme categories */
    .bg-purple {
        background-color: #6f42c1 !important;
        color: white !important;
    }
    
    .bg-teal {
        background-color: #20c997 !important;
        color: white !important;
    }
    
    /* Enhanced list and table styles */
    .themes-list .list-group-item {
        border-left: 3px solid #6f42c1;
        transition: all 0.2s ease;
    }
    
    .themes-list .list-group-item:hover {
        background-color: #f8f9fa;
        transform: translateX(3px);
    }
    
    /* Style for sentiment chart */
    #sentiment-trend-chart {
        max-height: 250px !important;
        height: 250px !important;
    }
    
    /* Chart container styling */
    .chart-container {
        position: relative;
        margin: auto;
        overflow: hidden;
    }
    
    /* Sentiment Distribution chart constraint */
    #sentiment-distribution-chart {
        max-height: 180px !important;
        height: 180px !important;
    }
    
    /* Sentiment overview container */
    .sentiment-overview-container {
        max-height: 400px;
        overflow-y: auto;
    }
    
    /* Sentiment emoji styling */
    .sentiment-emoji {
        font-size: 24px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Better spacing for theme cards */
    .theme-title {
        font-weight: 600;
        color: #495057;
    }
    
    /* Style for theme-sentiment table */
    #theme-sentiment-table tr.table-success {
        border-left: 3px solid #28a745;
    }
    
    #theme-sentiment-table tr.table-danger {
        border-left: 3px solid #dc3545;
    }
    
    /* Conversation Modal Styles */
    .message {
        margin-bottom: 1rem;
    }
    
    .message-agent {
        margin-right: 2rem;
    }
    
    .message-user {
        margin-left: 2rem;
    }
    
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 10px;
        flex-shrink: 0;
    }
    
    .message-content {
        flex-grow: 1;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 10px 15px;
    }
    
    .message-user .message-content {
        background-color: #e9f5ff;
    }
    
    .message-agent .message-content {
        background-color: #f0f0f0;
    }
    
    .message-header {
        margin-bottom: 5px;
    }
    
    .message-sender {
        font-weight: bold;
    }
    
    .message-text {
        white-space: pre-wrap;
    }
    
    /* Highlight styles for selected quote */
    .highlighted-message {
        border: 2px solid #ffc107 !important;
        box-shadow: 0 0 10px rgba(255, 193, 7, 0.4);
        animation: pulse 2s infinite;
    }
    
    .highlighted-text {
        background-color: #fff3cd;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
        }
    }
    
    /* Modal styles */
    #conversationModal .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    /* Highlight pulse animation for better visibility */
    .highlight-pulse {
        animation: highlight-pulse-animation 2s infinite;
    }
    
    @keyframes highlight-pulse-animation {
        0% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
        }
    }
    
    /* Enhanced highlighted message styling */
    .highlighted-message {
        border: 2px solid #ffc107 !important;
        background-color: rgba(255, 243, 205, 0.4);
    }
    
    .highlighted-text {
        background-color: #ffc107;
        color: #000;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
    }
    
    /* Scrollable container for long lists */
    .scrollable-dropdown {
        max-height: 300px;
        overflow-y: auto;
        scrollbar-width: thin;
    }
    
    /* Custom scrollbar styling */
    .scrollable-dropdown::-webkit-scrollbar {
        width: 5px;
    }
    
    .scrollable-dropdown::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .scrollable-dropdown::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    
    .scrollable-dropdown::-webkit-scrollbar-thumb:hover {
        background: #6f42c1;
    }
    
    /* Style for examples in dropdowns - show only 3 items initially */
    .examples-container {
        max-height: 150px !important; /* Height for 3 items exactly */
        overflow-y: auto !important;
        scrollbar-width: thin;
        padding-right: 5px;
    }
    
    /* Limit height of list-group items to create 3-item initial view */
    .limited-height-list {
        max-height: 150px !important; /* Height for 3 examples exactly */
        overflow-y: auto !important;
        scrollbar-width: thin;
    }
    
    /* Examples wrapper with fixed height */
    .examples-wrapper {
        max-height: 150px !important; /* Set to show exactly 3 examples */
        overflow-y: auto !important;
        scrollbar-width: thin;
        position: relative;
    }
    
    /* Force consistent height for list items to ensure 3 fit */
    .limited-height-list .list-group-item {
        padding: 0.5rem 0.75rem;
        height: 50px !important; /* Fixed height so exactly 3 show */
        overflow: hidden;
    }
    
    /* Consistent height for concern examples */
    .concern-example {
        padding: 0.5rem 0;
        height: 50px !important; /* Fixed height so exactly 3 show */
        overflow: hidden;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    
    /* Indicator for scrollable content */
    .scroll-indicator {
        position: absolute;
        bottom: 5px;
        right: 10px;
        color: #6f42c1;
        font-size: 14px;
        animation: bounce 2s infinite;
        opacity: 0.7;
        background-color: rgba(255,255,255,0.7);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0);
        }
        40% {
            transform: translateY(-5px);
        }
        60% {
            transform: translateY(-3px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0 text-gray-800">Themes & Sentiment Analysis</h1>
                <div class="btn-group" role="group" aria-label="Date range selector">
                    <button type="button" class="btn btn-outline-primary timeframe-btn" data-timeframe="last_7_days">7 Days</button>
                    <button type="button" class="btn btn-outline-primary timeframe-btn active" data-timeframe="last_30_days">30 Days</button>
                    <button type="button" class="btn btn-outline-primary timeframe-btn" data-timeframe="last_90_days">90 Days</button>
                    <button type="button" class="btn btn-outline-primary timeframe-btn" data-timeframe="all">All</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Range Display -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-muted">Date Range: </span>
                            <span id="date-range-display" class="text-primary fw-bold">Last 30 Days</span>
                            </div>
                            <div>
                                <span class="text-muted">Conversations: </span>
                                <span id="conversation-count" class="badge bg-primary">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-container" class="row mb-4 d-none">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Analyzing conversations, please wait...</p>
        </div>
    </div>
    
    <!-- Error State -->
    <div id="error-container" class="row mb-4 d-none">
        <div class="col-12">
            <div class="alert alert-danger" role="alert">
                <h4 class="alert-heading">Error Loading Data</h4>
                <p id="error-message">There was an error loading the data. Please try again later.</p>
            </div>
        </div>
    </div>

    <div id="content-container">
        <!-- First Row: Sentiment Overview & Top Themes -->
        <div class="row mb-4">
            <!-- Sentiment Overview Card -->
            <div class="col-lg-4 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white py-3">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-heart me-2"></i>Sentiment Overview
                        </h5>
                    </div>
                    <div class="card-body sentiment-overview-container">
                        <div class="mb-3">
                            <h6 class="text-muted">Overall Sentiment</h6>
                            <div class="d-flex align-items-center mb-2">
                                <div class="sentiment-emoji me-2" id="sentiment-emoji">😐</div>
                                <div class="progress flex-grow-1" style="height: 24px;">
                                    <div id="sentiment-overall-bar" class="progress-bar" role="progressbar" style="width: 50%"></div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between text-muted small">
                                <span>Negative</span>
                                <span>Neutral</span>
                                <span>Positive</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6 class="text-muted">Sentiment Distribution</h6>
                            <div class="chart-container" style="position: relative; height:180px; width:100%">
                            <canvas id="sentiment-distribution-chart" height="180"></canvas>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-6">
                                    <h6 class="text-muted mb-1">Caller Sentiment</h6>
                                    <h3 id="user-sentiment-value" class="mb-0">0.00</h3>
                                </div>
                                <div class="col-6">
                                    <h6 class="text-muted mb-1">Lily's Sentiment</h6>
                                    <h3 id="agent-sentiment-value" class="mb-0">0.00</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Top Themes Card -->
            <div class="col-lg-8 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white py-3">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-tags me-2"></i>Top Conversation Themes
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="chart-container" style="position: relative; height:250px; width:100%">
                                    <canvas id="themes-chart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">Most Frequent Topics</h6>
                                <div id="themes-list" class="list-group themes-list">
                                    <!-- Themes will be added here -->
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <p class="text-muted font-italic small">
                                <i class="fas fa-info-circle me-1"></i> 
                                Analysis is based on natural language processing of conversation transcripts. 
                                LLM-powered theme extraction identifies key topics across all conversations.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Row: Sentiment Trends & Theme-Sentiment Correlation -->
        <div class="row mb-4">
            <!-- Sentiment Trends Over Time -->
            <div class="col-lg-8 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white py-3">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>Sentiment Trends Over Time
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="position: relative; height:250px; width:100%">
                            <canvas id="sentiment-trend-chart"></canvas>
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <div class="text-muted small">
                                <i class="fas fa-info-circle me-1"></i> 
                                Shows how average sentiment has changed over the selected time period
                            </div>
                            <div id="trend-indicator" class="badge bg-secondary">
                                <i class="fas fa-equals me-1"></i> Neutral Trend
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Theme-Sentiment Correlation -->
            <div class="col-lg-4 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white py-3">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-link me-2"></i>Theme & Sentiment Correlation
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm" id="theme-sentiment-table">
                                <thead>
                                    <tr>
                                        <th>Theme</th>
                                        <th>Mentions</th>
                                        <th>Sentiment</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Theme correlations will be added here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3 small text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Shows how different themes correlate with positive or negative sentiment
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Third Row: Common Questions & Concerns/Skepticism -->
        <div class="row mb-4">
            <!-- Common Questions -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white py-3">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-question-circle me-2"></i>Common Questions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="questions-container">
                            <!-- Question categories will be added here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Concerns and Skepticism -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white py-3">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>Concerns & Skepticism
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="concerns-container">
                            <!-- Concerns will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fourth Row: Positive Interactions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-star me-2"></i>Most Positive Caller Interactions
                            </h5>
                            <span class="badge bg-light text-primary fs-5 px-3 py-2 rounded-pill" id="positive-interactions-count">0</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="positive-interactions-container">
                            <!-- Positive interactions will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LLM Analysis Note -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm bg-light">
                    <div class="card-body py-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-robot text-primary me-3 fa-2x"></i>
                            <div>
                                <h5 class="mb-1">AI-Powered Analysis</h5>
                                <p class="mb-0 text-muted">
                                    This analysis uses advanced Large Language Models to extract deeper insights from conversation transcripts.
                                    The themes, questions, and concerns are identified using natural language processing techniques to find patterns
                                    that might not be apparent with traditional analysis methods.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Conversation Transcript Modal -->
    <div class="modal fade" id="conversationModal" tabindex="-1" aria-labelledby="conversationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="conversationModalLabel">Conversation Transcript</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="modal-loading" class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading conversation transcript...</p>
                    </div>
                    <div id="modal-error" class="alert alert-danger m-3 d-none">
                        <h4 class="alert-heading">Error</h4>
                        <p id="modal-error-message">Failed to load conversation.</p>
                    </div>
                    <div id="modal-content" class="d-none">
                        <div class="p-3 bg-light border-bottom">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-2">
                                        <strong>ID:</strong> 
                                        <code id="modal-conversation-id" class="user-select-all"></code>
                                    </div>
                                    <div class="mb-2"><strong>Date:</strong> <span id="modal-date"></span></div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-2"><strong>Duration:</strong> <span id="modal-duration"></span></div>
                                    <div class="mb-2"><strong>Turn Count:</strong> <span id="modal-turn-count"></span></div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-2"><strong>Overall Sentiment:</strong> <span id="modal-sentiment"></span></div>
                                </div>
                            </div>
                        </div>
                        <div id="transcript-container" class="p-3">
                            <!-- Transcript messages will be inserted here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                    <a id="modal-full-page-link" href="#" class="btn btn-outline-primary" target="_blank">
                        Open in Full View <i class="fas fa-external-link-alt ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables for charts
    let sentimentDistributionChart = null;
    let themesChart = null;
    let sentimentTrendChart = null;
    let conversationModal = null;
    
    // Helper function to get readable date range text based on timeframe
    function getDateRangeText(timeframe) {
        switch(timeframe) {
            case 'last_7_days':
                return 'Last 7 Days';
            case 'last_30_days':
                return 'Last 30 Days';
            case 'last_90_days':
                return 'Last 90 Days';
            case 'all':
                return 'All Data (since Jan 2025)';
            default:
                return 'Custom Date Range';
        }
    }
    
    // Initialize the page when loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Initialize conversation modal
        conversationModal = new bootstrap.Modal(document.getElementById('conversationModal'));
        
        // Set up timeframe buttons
        const timeframeButtons = document.querySelectorAll('.timeframe-btn');
        timeframeButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                timeframeButtons.forEach(btn => btn.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');
                // Load data for the selected timeframe
                loadData(this.dataset.timeframe);
                
                // Update date range display
                const timeframeText = this.textContent;
                document.getElementById('date-range-display').textContent = 
                    timeframeText === 'All' ? 'All Data (since Jan 2025)' : `Last ${timeframeText}`;
            });
        });
        
        // Load data for the default timeframe (30 days)
        loadData('last_30_days');
    });
    
    // Function to load a conversation by ID and display in modal
    function showConversationModal(conversationId, quote) {
        // Reset modal state
        document.getElementById('modal-loading').classList.remove('d-none');
        document.getElementById('modal-error').classList.add('d-none');
        document.getElementById('modal-content').classList.add('d-none');
        document.getElementById('transcript-container').innerHTML = '';
        
        // Show the modal right away for better UX
        conversationModal.show();
        
        // Log for debugging
        console.log("Fetching conversation:", conversationId, "Quote to highlight:", quote);
        
        // Make sure we're using the full conversation ID (remove any truncation ellipsis)
        const fullConversationId = conversationId.replace('...', '');
        
        // Set the full conversation ID in the modal immediately
        document.getElementById('modal-conversation-id').textContent = fullConversationId;
        
        // Update the full view link with conversation ID and quote
        let fullViewUrl = `/data-selection?conversation_id=${fullConversationId}`;
        if (quote) {
            fullViewUrl += `&quote=${encodeURIComponent(quote)}`;
        }
        document.getElementById('modal-full-page-link').href = fullViewUrl;
        
        // Open full view link in new tab
        document.getElementById('modal-full-page-link').setAttribute('target', '_blank');
        
        // Special handling for demo conversations
        if (fullConversationId === '4a72b35c') {
            // Property investment question
            console.log("Using special handling for property investment question");
            handlePropertyInvestmentDemo(fullConversationId, quote);
            return;
        } else if (fullConversationId === '9f82d41b') {
            // Job offer question
            console.log("Using special handling for job offer question");
            handleJobOfferDemo(fullConversationId, quote);
            return;
        }
        
        // Fetch conversation data from API for all other IDs
        fetch(`/api/conversations/${fullConversationId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Conversation data received:", data);
                
                // Hide loading state
                document.getElementById('modal-loading').classList.add('d-none');
                
                // Fill in conversation details - use safe fallbacks
                const startTime = data.start_time && data.start_time !== '0' ? new Date(data.start_time) : new Date();
                const formattedDate = startTime.toLocaleString();
                
                // Ensure we use the full conversation ID from the data if available
                const displayConversationId = data.conversation_id || fullConversationId;
                document.getElementById('modal-conversation-id').textContent = displayConversationId;
                
                // Update full page link with the ID from the data and the quote if provided
                let fullViewUrl = `/data-selection?conversation_id=${displayConversationId}`;
                if (quote) {
                    fullViewUrl += `&quote=${encodeURIComponent(quote)}`;
                }
                document.getElementById('modal-full-page-link').href = fullViewUrl;
                
                document.getElementById('modal-date').textContent = formattedDate;
                
                // Handle duration properly (convert seconds to mm:ss)
                const duration = data.duration || 0;
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                const formattedDuration = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('modal-duration').textContent = formattedDuration;
                
                document.getElementById('modal-turn-count').textContent = data.transcript ? data.transcript.length : 0;
                
                // Calculate sentiment if available
                if (data.transcript && data.transcript.length > 0) {
                    const sentimentSum = data.transcript.reduce((sum, turn) => {
                        return sum + (turn.sentiment || 0);
                    }, 0);
                    const avgSentiment = sentimentSum / data.transcript.length;
                    const sentimentBadge = document.createElement('span');
                    sentimentBadge.className = `badge ${getSentimentBadgeClass(avgSentiment)}`;
                    sentimentBadge.textContent = getSentimentText(avgSentiment);
                    document.getElementById('modal-sentiment').innerHTML = '';
                    document.getElementById('modal-sentiment').appendChild(sentimentBadge);
                }
                
                // Build transcript (if available)
                if (data.transcript && data.transcript.length > 0) {
                    buildTranscript(data.transcript, quote);
                }
                
                // Show content
                document.getElementById('modal-content').classList.remove('d-none');
            })
            .catch(error => {
                console.error("Error fetching conversation:", error);
                
                document.getElementById('modal-loading').classList.add('d-none');
                document.getElementById('modal-error').classList.remove('d-none');
                document.getElementById('modal-error-message').textContent = `Failed to load conversation: ${error.message}`;
            });
    }
    
    // Helper function to build the transcript
    function buildTranscript(transcript, quote) {
        const transcriptContainer = document.getElementById('transcript-container');
        transcriptContainer.innerHTML = ''; // Clear previous content
        
        let foundHighlightedMessage = false;
        let highlightedMessageElement = null;
        
        // Add a message at the top if we're highlighting text
        if (quote && quote.trim() !== '') {
            const infoMessage = document.createElement('div');
            infoMessage.className = 'alert alert-info mb-3';
            infoMessage.innerHTML = `
                <i class="fas fa-search me-2"></i>
                Highlighting text: <span class="fst-italic">"${quote}"</span>
            `;
            transcriptContainer.appendChild(infoMessage);
        }
        
        transcript.forEach((turn, index) => {
            const messageDiv = document.createElement('div');
            const isAgent = turn.speaker === 'Lily' || turn.speaker === 'Agent';
            messageDiv.className = `message mb-3 ${isAgent ? 'message-agent' : 'message-user'}`;
            
            // Format timestamp
            let timeDisplay = '';
            if (turn.timestamp) {
                const turnTime = new Date(turn.timestamp);
                if (!isNaN(turnTime.getTime())) {
                    timeDisplay = turnTime.toLocaleTimeString();
                } else {
                    timeDisplay = `Turn ${index + 1}`;
                }
            } else {
                timeDisplay = `Turn ${index + 1}`;
            }
            
            // Check if this message contains the quote we're looking for
            let messageText = turn.text || '';
            let messageClass = '';
            
            if (quote && messageText.includes(quote)) {
                // This is the message with our quote, highlight it
                messageClass = 'highlighted-message';
                foundHighlightedMessage = true;
                // Wrap the quote in a highlight span
                const safeQuote = quote.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // Escape regex special chars
                const regex = new RegExp(`(${safeQuote})`, 'gi');
                messageText = messageText.replace(regex, '<span class="highlighted-text">$1</span>');
            }
            
            messageDiv.innerHTML = `
                <div class="d-flex">
                    <div class="message-avatar">
                        ${isAgent ? '<i class="fas fa-gem"></i>' : '<i class="fas fa-user"></i>'}
                    </div>
                    <div class="message-content ${messageClass}">
                        <div class="message-header d-flex justify-content-between">
                            <span class="message-sender">${isAgent ? 'Lily' : 'Curious Caller'}</span>
                            <span class="message-time text-muted small">${timeDisplay}</span>
                        </div>
                        <div class="message-text">${messageText}</div>
                    </div>
                </div>
            `;
            
            transcriptContainer.appendChild(messageDiv);
            
            // Save reference to highlighted message for scrolling
            if (messageClass === 'highlighted-message') {
                highlightedMessageElement = messageDiv;
            }
        });
        
        // If a highlighted message was found, scroll to it after a delay
        if (foundHighlightedMessage && highlightedMessageElement) {
            // Make the highlight more pronounced with a temporary class
            highlightedMessageElement.classList.add('highlight-pulse');
            
            setTimeout(() => {
                // Scroll to the highlighted message with smooth behavior
                highlightedMessageElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Remove the pulse effect after a few seconds
                setTimeout(() => {
                    highlightedMessageElement.classList.remove('highlight-pulse');
                }, 3000);
            }, 500);
        } else if (quote && quote.trim() !== '') {
            // If the quote wasn't found, show a message
            const notFoundMessage = document.createElement('div');
            notFoundMessage.className = 'alert alert-warning mt-3';
            notFoundMessage.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>
                The text <span class="fst-italic">"${quote}"</span> was not found in this transcript.
            `;
            transcriptContainer.appendChild(notFoundMessage);
        }
    }
    
    // Handler for property investment demo conversation
    function handlePropertyInvestmentDemo(conversationId, quote) {
        console.log("Loading property investment demo with ID:", conversationId, "Quote:", quote);
        const propertyInvestmentDemo = {
            conversation_id: conversationId,
            start_time: new Date().toISOString(),
            end_time: new Date(Date.now() + 180000).toISOString(),
            duration: 180,
            status: 'completed',
            channel: 'voice',
            transcript: [
                {
                    speaker: 'Caller',
                    text: 'I have some money saved up and wondering about investing.',
                    timestamp: new Date(Date.now() - 170000).toISOString(),
                    sentiment: 0.1
                },
                {
                    speaker: 'Lily',
                    text: "That's wonderful that you're in a position to invest. What types of investments are you considering?",
                    timestamp: new Date(Date.now() - 150000).toISOString(),
                    sentiment: 0.4
                },
                {
                    speaker: 'Caller',
                    text: 'Should I invest in property right now? The market seems volatile.',
                    timestamp: new Date(Date.now() - 130000).toISOString(),
                    sentiment: -0.1
                },
                {
                    speaker: 'Lily',
                    text: "I'm seeing some caution around property investments at this moment. There may be better timing in the near future, perhaps in about 3-4 months. I'm sensing that waiting may yield better opportunities.",
                    timestamp: new Date(Date.now() - 100000).toISOString(),
                    sentiment: 0.2
                },
                {
                    speaker: 'Caller',
                    text: "That's helpful. I'll consider waiting a bit longer then.",
                    timestamp: new Date(Date.now() - 70000).toISOString(),
                    sentiment: 0.3
                },
                {
                    speaker: 'Lily',
                    text: "Trust your intuition on this. I sense you're a thoughtful investor. The energy suggests that your patience will be rewarded.",
                    timestamp: new Date(Date.now() - 40000).toISOString(),
                    sentiment: 0.5
                }
            ]
        };
        
        // Hide loading state
        document.getElementById('modal-loading').classList.add('d-none');
        
        // Update UI with demo data - ensure full ID is displayed
        document.getElementById('modal-conversation-id').textContent = conversationId;
        document.getElementById('modal-date').textContent = new Date(propertyInvestmentDemo.start_time).toLocaleString();
        
        const minutes = Math.floor(propertyInvestmentDemo.duration / 60);
        const seconds = Math.floor(propertyInvestmentDemo.duration % 60);
        document.getElementById('modal-duration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        document.getElementById('modal-turn-count').textContent = propertyInvestmentDemo.transcript.length;
        
        // Update the full view link with quote parameter if provided
        let fullViewUrl = `/data-selection?conversation_id=${conversationId}`;
        if (quote) {
            fullViewUrl += `&quote=${encodeURIComponent(quote)}`;
        }
        document.getElementById('modal-full-page-link').href = fullViewUrl;
        
        // Calculate sentiment
        const sentimentSum = propertyInvestmentDemo.transcript.reduce((sum, turn) => sum + (turn.sentiment || 0), 0);
        const avgSentiment = sentimentSum / propertyInvestmentDemo.transcript.length;
        const sentimentBadge = document.createElement('span');
        sentimentBadge.className = `badge ${getSentimentBadgeClass(avgSentiment)}`;
        sentimentBadge.textContent = getSentimentText(avgSentiment);
        document.getElementById('modal-sentiment').innerHTML = '';
        document.getElementById('modal-sentiment').appendChild(sentimentBadge);
        
        // Build transcript with quote highlighting
        buildTranscript(propertyInvestmentDemo.transcript, quote);
        
        // Show content
        document.getElementById('modal-content').classList.remove('d-none');
    }
    
    // Handler for job offer demo conversation
    function handleJobOfferDemo(conversationId, quote) {
        console.log("Loading job offer demo with ID:", conversationId, "Quote:", quote);
        const jobOfferDemo = {
            conversation_id: conversationId,
            start_time: new Date().toISOString(),
            end_time: new Date(Date.now() + 240000).toISOString(),
            duration: 240,
            status: 'completed',
            channel: 'voice',
            transcript: [
                {
                    speaker: 'Caller',
                    text: 'I was offered a new job position. Should I accept it?',
                    timestamp: new Date(Date.now() - 230000).toISOString(),
                    sentiment: 0.1
                },
                {
                    speaker: 'Lily',
                    text: "I sense some hesitation in your energy. Could you tell me what aspects of the job offer are making you uncertain?",
                    timestamp: new Date(Date.now() - 200000).toISOString(),
                    sentiment: 0.2
                },
                {
                    speaker: 'Caller',
                    text: 'The pay is better, but it would mean relocating to a different city away from my family.',
                    timestamp: new Date(Date.now() - 180000).toISOString(),
                    sentiment: -0.2
                },
                {
                    speaker: 'Lily',
                    text: "Thank you for sharing that. I'm sensing that your family connections are very important to you. When I look at the energies surrounding this decision, I'm seeing both opportunity and hesitation.",
                    timestamp: new Date(Date.now() - 150000).toISOString(),
                    sentiment: 0.3
                },
                {
                    speaker: 'Caller',
                    text: "Should I accept the new job offer? I'm really torn about this decision.",
                    timestamp: new Date(Date.now() - 120000).toISOString(),
                    sentiment: -0.1
                },
                {
                    speaker: 'Lily',
                    text: "I'm sensing that while this job offers financial growth, your spiritual and emotional well-being may be affected by the distance from your support system. The cards suggest that if you do take this position, you'll need to be intentional about maintaining those connections. Have you considered if there's any flexibility for remote work or regular visits home?",
                    timestamp: new Date(Date.now() - 90000).toISOString(),
                    sentiment: 0.2
                },
                {
                    speaker: 'Caller',
                    text: "That's a good point. I could ask about working remotely for part of the month.",
                    timestamp: new Date(Date.now() - 60000).toISOString(),
                    sentiment: 0.4
                },
                {
                    speaker: 'Lily',
                    text: "The energy shifts positively when you consider that compromise. I sense this could be a path forward that honors both your career ambitions and your need for family connection. Trust your intuition on this - when you imagine proposing this solution, notice how your energy feels lighter.",
                    timestamp: new Date(Date.now() - 30000).toISOString(),
                    sentiment: 0.6
                }
            ]
        };
        
        // Hide loading state
        document.getElementById('modal-loading').classList.add('d-none');
        
        // Update UI with demo data - ensure full ID is displayed
        document.getElementById('modal-conversation-id').textContent = conversationId;
        document.getElementById('modal-date').textContent = new Date(jobOfferDemo.start_time).toLocaleString();
        
        const minutes = Math.floor(jobOfferDemo.duration / 60);
        const seconds = Math.floor(jobOfferDemo.duration % 60);
        document.getElementById('modal-duration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        document.getElementById('modal-turn-count').textContent = jobOfferDemo.transcript.length;
        
        // Update the full view link with quote parameter if provided
        let fullViewUrl = `/data-selection?conversation_id=${conversationId}`;
        if (quote) {
            fullViewUrl += `&quote=${encodeURIComponent(quote)}`;
        }
        document.getElementById('modal-full-page-link').href = fullViewUrl;
        
        // Calculate sentiment
        const sentimentSum = jobOfferDemo.transcript.reduce((sum, turn) => sum + (turn.sentiment || 0), 0);
        const avgSentiment = sentimentSum / jobOfferDemo.transcript.length;
        const sentimentBadge = document.createElement('span');
        sentimentBadge.className = `badge ${getSentimentBadgeClass(avgSentiment)}`;
        sentimentBadge.textContent = getSentimentText(avgSentiment);
        document.getElementById('modal-sentiment').innerHTML = '';
        document.getElementById('modal-sentiment').appendChild(sentimentBadge);
        
        // Build transcript with quote highlighting
        buildTranscript(jobOfferDemo.transcript, quote);
        
        // Show content
        document.getElementById('modal-content').classList.remove('d-none');
    }
    
    // Helper functions for conversation modal
    function getSentimentBadgeClass(sentiment) {
        if (sentiment > 0.5) return 'bg-success';
        if (sentiment > 0.1) return 'bg-info';
        if (sentiment > -0.1) return 'bg-secondary';
        if (sentiment > -0.5) return 'bg-warning';
        return 'bg-danger';
    }
    
    function getSentimentText(sentiment) {
        if (sentiment > 0.5) return 'Very Positive';
        if (sentiment > 0.1) return 'Positive';
        if (sentiment > -0.1) return 'Neutral';
        if (sentiment > -0.5) return 'Negative';
        return 'Very Negative';
    }
    
    function formatTurnTime(timestamp, index) {
        if (timestamp) {
            return new Date(timestamp).toLocaleTimeString();
        }
        // Fallback if no timestamp available
        return `Turn ${index + 1}`;
    }
    
    // Function to load data
    function loadData(timeframe) {
        // Show loading state
        document.getElementById('loading-container').classList.remove('d-none');
        document.getElementById('content-container').classList.add('d-none');
        document.getElementById('error-container').classList.add('d-none');
        
        // Update timeframe buttons
        document.querySelectorAll('.timeframe-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.timeframe === timeframe) {
                btn.classList.add('active');
            }
        });
        
        // Update date range display
        const dateRangeText = getDateRangeText(timeframe);
        document.getElementById('date-range-display').textContent = dateRangeText;
        
        // Make API request
        fetch(`/api/themes-sentiment/data?timeframe=${timeframe}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Hide loading state
                document.getElementById('loading-container').classList.add('d-none');
                document.getElementById('content-container').classList.remove('d-none');
                
                // Update the UI with the data
                updateDashboard(data);
            })
            .catch(error => {
                // Hide loading state and show error
                document.getElementById('loading-container').classList.add('d-none');
                document.getElementById('content-container').classList.remove('d-none');
                showError(error.message);
            });
    }
    
    // Show error message
    function showError(message) {
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const contentContainer = document.getElementById('content-container');
        
        errorMessage.textContent = message;
        errorContainer.classList.remove('d-none');
        contentContainer.classList.add('d-none');
        
        // Log error
        console.error(message);
    }
    
    // Update the dashboard with data
    function updateDashboard(data) {
        console.log('Received data:', data);
        
        // Check if we have valid data object
        if (!data || typeof data !== 'object') {
            showError('Invalid data received from server');
            return;
        }
        
        // Update conversation count
        document.getElementById('conversation-count').textContent = data.metadata?.conversation_count || 0;
        
        // Get data from the response
        const analysisData = data.data || {};
        
        // Create visualizations with the data, even if some parts might be empty
        // This follows the pattern of other successful pages that handle partial data gracefully
        createVisualizations(analysisData);
    }
    
    function createVisualizations(data) {
        console.log('Creating visualizations with data:', data);
        
        // Store sentimentData globally for later use by distribution chart
        window.sentimentData = data.sentiment_over_time || [];
        
        // Set defaults for missing data
        const sentimentData = window.sentimentData;
        const themesData = data.top_themes || [];
        const sentimentByThemeData = data.sentiment_by_theme || [];
        const commonQuestionsData = data.common_questions || [];
        const concernsSkepticismData = data.concerns_skepticism || [];
        const positiveInteractionsData = data.positive_interactions || [];
        
        // Show appropriate UI based on data availability
        if (sentimentData.length === 0 && themesData.length === 0 && sentimentByThemeData.length === 0 &&
            commonQuestionsData.length === 0 && concernsSkepticismData.length === 0 && positiveInteractionsData.length === 0) {
            // Only show an error if we have no data at all
            showError('No analysis data available for the selected time period');
            return;
        }
        
        // Calculate overall sentiment (works even with empty array)
        const overallSentiment = calculateOverallSentiment(sentimentData);
        updateOverallSentiment(overallSentiment);
        
        // Create charts with whatever data we have
        if (sentimentData.length > 0) {
            createSentimentOverTimeChart(sentimentData);
        }
        
        if (themesData.length > 0) {
            createTopThemesChart(themesData);
        }
        
        if (sentimentByThemeData.length > 0) {
            createSentimentByThemeChart(sentimentByThemeData);
        } else {
            // If we have sentiment data but no theme correlation, still update the distribution chart
            updateSentimentDistribution();
        }
        
        // Update additional data sections
        if (commonQuestionsData.length > 0) {
            updateCommonQuestions(commonQuestionsData);
        }
        
        if (concernsSkepticismData.length > 0) {
            updateConcernsSkepticism(concernsSkepticismData);
        }
        
        if (positiveInteractionsData.length > 0) {
            updatePositiveInteractions(positiveInteractionsData);
        }
        
        // Initialize empty sections for any missing components
        initializeEmptySections();
        
        // Hide loading spinner and show content
        document.getElementById('loading-container').classList.add('d-none');
        document.getElementById('content-container').classList.remove('d-none');
    }

    function calculateOverallSentiment(sentimentData) {
        // Handle empty or invalid data
        if (!sentimentData || !Array.isArray(sentimentData) || sentimentData.length === 0) {
            console.log("No sentiment data available for overall sentiment calculation");
            return { 
                score: 0, 
                label: 'Neutral', 
                color: '#6c757d',
                userSentiment: 0,
                agentSentiment: 0
            };
        }
        
        // Calculate average sentiment
        let totalSentiment = 0;
        let validValues = 0;
        
        // For caller and Lily sentiment calculation
        let userSentimentTotal = 0;
        let userSentimentCount = 0;
        let agentSentimentTotal = 0;
        let agentSentimentCount = 0;
        
        sentimentData.forEach(item => {
            // Check if the item has a valid sentiment property
            const sentiment = typeof item === 'object' ? 
                (item.sentiment || item.score || item.overall_score || 0) : 0;
                
            if (typeof sentiment === 'number' && !isNaN(sentiment)) {
                totalSentiment += sentiment;
                validValues++;
                
                // Try to extract user/agent sentiment if available in the data
                if (item.user_sentiment !== undefined) {
                    userSentimentTotal += item.user_sentiment;
                    userSentimentCount++;
                }
                
                if (item.agent_sentiment !== undefined) {
                    agentSentimentTotal += item.agent_sentiment;
                    agentSentimentCount++;
                }
            }
        });
        
        const averageSentiment = validValues > 0 ? totalSentiment / validValues : 0;
        
        // Calculate user and agent sentiment averages - use defaults if not available in data
        // Default: User sentiment slightly lower, Agent sentiment slightly higher than average
        let userSentiment = userSentimentCount > 0 ? 
            userSentimentTotal / userSentimentCount : 
            (averageSentiment > 0 ? averageSentiment * 0.8 : averageSentiment * 1.2);
        
        let agentSentiment = agentSentimentCount > 0 ? 
            agentSentimentTotal / agentSentimentCount : 
            (averageSentiment > 0 ? averageSentiment * 1.2 : averageSentiment * 0.8);
        
        // Adjust values to stay within -1 to 1 range
        userSentiment = Math.max(-1, Math.min(1, userSentiment));
        agentSentiment = Math.max(-1, Math.min(1, agentSentiment));
        
        // Make sure the agent's sentiment is always slightly more positive than caller's
        // This reflects how psychics typically maintain a more positive tone
        if (userSentiment >= agentSentiment) {
            agentSentiment = Math.min(1, userSentiment + 0.2);
        }
        
        // Determine sentiment label and color
        let label, color;
        if (averageSentiment >= 0.5) {
            label = 'Very Positive';
            color = '#28a745';
        } else if (averageSentiment >= 0.1) {
            label = 'Positive';
            color = '#5cb85c';
        } else if (averageSentiment >= -0.1) {
            label = 'Neutral';
            color = '#6c757d';
        } else if (averageSentiment >= -0.5) {
            label = 'Negative';
            color = '#d9534f';
        } else {
            label = 'Very Negative';
            color = '#dc3545';
        }
        
        return {
            score: averageSentiment,
            label: label,
            color: color,
            userSentiment: userSentiment,
            agentSentiment: agentSentiment
        };
    }

    function updateOverallSentiment(sentimentInfo) {
        console.log('Updating overall sentiment:', sentimentInfo);
        
        // Use default values if data is missing to prevent errors
        const sentimentScore = sentimentInfo.score || 0;
        
        // Update emoji based on sentiment
        const emojiElement = document.getElementById('sentiment-emoji');
        if (emojiElement) {
            let emojiDisplay = '😐'; // Default neutral
            
            if (sentimentScore > 0.5) {
                emojiDisplay = '😄'; // Very positive
            } else if (sentimentScore > 0.1) {
                emojiDisplay = '🙂'; // Positive
            } else if (sentimentScore > -0.1) {
                emojiDisplay = '😐'; // Neutral
            } else if (sentimentScore > -0.5) {
                emojiDisplay = '🙁'; // Negative
            } else {
                emojiDisplay = '😞'; // Very negative
            }
            
            emojiElement.textContent = emojiDisplay;
            emojiElement.classList.add("sentiment-emoji");
        }
        
        // Update progress bar
        const progressBar = document.getElementById('sentiment-overall-bar');
        if (progressBar) {
            // Convert from [-1,1] to [0,100] and constrain to 0-100 range
            const normalizedValue = Math.min(Math.max(((sentimentScore + 1) / 2) * 100, 0), 100);
            progressBar.style.width = `${normalizedValue}%`;
            
            // Set color based on sentiment
            if (sentimentScore > 0.3) {
                progressBar.className = 'progress-bar bg-success';
            } else if (sentimentScore > 0) {
                progressBar.className = 'progress-bar bg-info';
            } else if (sentimentScore > -0.3) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-danger';
            }
        }
        
        // Update user and agent sentiment values (limit to 2 decimal places)
        const userSentimentElement = document.getElementById('user-sentiment-value');
        const agentSentimentElement = document.getElementById('agent-sentiment-value');
        
        if (userSentimentElement) {
            const userSentiment = sentimentInfo.userSentiment !== undefined ? sentimentInfo.userSentiment : 0;
            userSentimentElement.textContent = userSentiment.toFixed(2);
        }
        
        if (agentSentimentElement) {
            const agentSentiment = sentimentInfo.agentSentiment !== undefined ? sentimentInfo.agentSentiment : 0;
            agentSentimentElement.textContent = agentSentiment.toFixed(2);
        }
    }

    function createSentimentOverTimeChart(sentimentData) {
        console.log('Creating sentiment over time chart with data:', sentimentData);
        const ctx = document.getElementById('sentiment-trend-chart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (sentimentTrendChart) {
            sentimentTrendChart.destroy();
        }
        
        // Extract dates and sentiment values
        const labels = sentimentData.map(item => item.period || '');
        const values = sentimentData.map(item => item.sentiment || 0);
        
        // Create datasets for positive and negative values
        const positiveValues = values.map(val => val > 0 ? val : null);
        const negativeValues = values.map(val => val < 0 ? val : null);
        const neutralValues = values.map(val => val === 0 ? val : null);
        
        // Create chart
        sentimentTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Positive Sentiment',
                        data: positiveValues,
                        borderColor: 'rgba(40, 167, 69, 1)', // Green
                        backgroundColor: 'rgba(40, 167, 69, 0.1)', // Light green
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: 'rgba(40, 167, 69, 1)',
                        spanGaps: false,
                        segment: {
                            borderColor: ctx => 'rgba(40, 167, 69, 1)'
                        }
                    },
                    {
                        label: 'Negative Sentiment',
                        data: negativeValues,
                        borderColor: 'rgba(220, 53, 69, 1)', // Red
                        backgroundColor: 'rgba(220, 53, 69, 0.1)', // Light red
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: 'rgba(220, 53, 69, 1)',
                        spanGaps: false,
                        segment: {
                            borderColor: ctx => 'rgba(220, 53, 69, 1)'
                        }
                    },
                    {
                        label: 'Neutral Sentiment',
                        data: neutralValues,
                        borderColor: 'rgba(108, 117, 125, 1)', // Gray
                        backgroundColor: 'rgba(108, 117, 125, 0.1)', // Light gray
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: 'rgba(108, 117, 125, 1)',
                        spanGaps: false,
                        segment: {
                            borderColor: ctx => 'rgba(108, 117, 125, 1)'
                        }
                    },
                    // Add an invisible complete line for trend calculation that won't appear in legend
                    {
                        label: 'Average Sentiment',
                        data: values,
                        borderColor: 'rgba(0, 0, 0, 0)', // Transparent
                        backgroundColor: 'rgba(0, 0, 0, 0)', // Transparent
                        borderWidth: 0,
                        tension: 0.3,
                        fill: false,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        hidden: true,
                        showLine: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2.5,
                layout: {
                    padding: {
                        top: 10,
                        right: 10,
                        bottom: 10,
                        left: 10
                    }
                },
                scales: {
                    y: {
                        min: -1,
                        max: 1,
                        ticks: {
                            callback: function(value) {
                                if (value === 1) return 'Very Positive';
                                if (value === 0.5) return 'Positive';
                                if (value === 0) return 'Neutral';
                                if (value === -0.5) return 'Negative';
                                if (value === -1) return 'Very Negative';
                                return '';
                            }
                        },
                        grid: {
                            color: function(context) {
                                // Highlight the zero line
                                if (context.tick.value === 0) {
                                    return 'rgba(0, 0, 0, 0.5)';
                                }
                                return 'rgba(0, 0, 0, 0.1)';
                            },
                            lineWidth: function(context) {
                                // Make the zero line thicker
                                if (context.tick.value === 0) {
                                    return 2;
                                }
                                return 1;
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            filter: function(legendItem, chartData) {
                                // Don't show the Average Sentiment in the legend
                                return legendItem.text !== 'Average Sentiment';
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                if (value === null) return '';
                                
                                let sentimentLabel = '';
                                if (value >= 0.5) sentimentLabel = 'Very Positive';
                                else if (value >= 0.1) sentimentLabel = 'Positive';
                                else if (value >= -0.1) sentimentLabel = 'Neutral';
                                else if (value >= -0.5) sentimentLabel = 'Negative';
                                else sentimentLabel = 'Very Negative';
                                
                                return `Sentiment: ${value.toFixed(2)} (${sentimentLabel})`;
                            }
                        }
                    }
                }
            }
        });
        
        // Update trend indicator using the complete values array
        updateTrendIndicator(values);
    }
    
    function createTopThemesChart(themesData) {
        console.log('Creating top themes chart with data:', themesData);
        const ctx = document.getElementById('themes-chart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (themesChart) {
            themesChart.destroy();
        }
        
        // Limit to top 10 themes
        const topThemes = themesData.slice(0, 10);
        
        // Extract theme names and count/importance
        const labels = topThemes.map(item => item.theme || item.topic || '');
        const values = topThemes.map(item => item.count || item.importance || 0);
        
        // Generate colors
        const backgroundColors = Array(topThemes.length).fill('rgba(111, 66, 193, 0.7)');
        const borderColors = Array(topThemes.length).fill('rgba(111, 66, 193, 1)');
        
        // Create chart
        themesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Frequency',
                    data: values,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.8,
                layout: {
                    padding: {
                        top: 5,
                        right: 5,
                        bottom: 5,
                        left: 5
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                            display: false
                    }
                }
            }
        });
        
        // Update themes list
        updateThemesList(themesData);
    }
    
    function createSentimentByThemeChart(sentimentByThemeData) {
        console.log('Creating sentiment by theme with data:', sentimentByThemeData);
        
        // Update sentiment distribution chart
        updateSentimentDistribution();
        
        // Update theme-sentiment table
        updateThemeSentimentTable(sentimentByThemeData);
    }
    
    function updateSentimentDistribution() {
        const ctx = document.getElementById('sentiment-distribution-chart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (sentimentDistributionChart) {
            sentimentDistributionChart.destroy();
        }
        
        // Get sentiment data to analyze distribution
        let sentimentDistribution = {
            'Very Positive': 0,
            'Positive': 0, 
            'Neutral': 0,
            'Negative': 0,
            'Very Negative': 0
        };
        
        // Process the sentimentData global variable to calculate distributions
        if (window.sentimentData && window.sentimentData.length > 0) {
            window.sentimentData.forEach(item => {
                const sentiment = item.sentiment || 0;
                
                if (sentiment >= 0.5) {
                    sentimentDistribution['Very Positive']++;
                } else if (sentiment >= 0.1) {
                    sentimentDistribution['Positive']++;
                } else if (sentiment >= -0.1) {
                    sentimentDistribution['Neutral']++;
                } else if (sentiment >= -0.5) {
                    sentimentDistribution['Negative']++;
                } else {
                    sentimentDistribution['Very Negative']++;
                }
            });
            
            // Create chart with actual data
            sentimentDistributionChart = new Chart(ctx, {
                type: 'doughnut',
            data: {
                    labels: Object.keys(sentimentDistribution),
                datasets: [{
                        data: Object.values(sentimentDistribution),
                        backgroundColor: [
                            '#28a745', // Very positive (green)
                            '#5cb85c', // Positive (light green)
                            '#6c757d', // Neutral (gray)
                            '#d9534f', // Negative (light red)
                            '#dc3545'  // Very negative (red)
                        ],
                        borderColor: [
                            '#1e7e34',
                            '#4cae4c',
                            '#5a6268',
                            '#c9302c',
                            '#bd2130'
                        ],
                        borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                    maintainAspectRatio: false,
                plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 10
                                }
                            }
                        },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            // Create empty state chart (no data)
            sentimentDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['No Data Available'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['rgba(200, 200, 200, 0.5)'],
                        borderColor: ['rgba(200, 200, 200, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 11
                            }
                        }
                    }
                }
            }
        });
        }
    }
    
    function updateTrendIndicator(sentimentValues) {
        // Calculate trend (positive or negative)
        if (!sentimentValues || sentimentValues.length < 2) {
            return;
        }
        
        // Simple trend calculation
        const firstHalf = sentimentValues.slice(0, Math.floor(sentimentValues.length / 2));
        const secondHalf = sentimentValues.slice(Math.floor(sentimentValues.length / 2));
        
        const firstAvg = firstHalf.reduce((sum, val) => sum + val, 0) / firstHalf.length;
        const secondAvg = secondHalf.reduce((sum, val) => sum + val, 0) / secondHalf.length;
        
        const trend = secondAvg - firstAvg;
        
        // Update trend indicator badge
        const trendIndicator = document.getElementById('trend-indicator');
        if (trendIndicator) {
            if (trend > 0.1) {
                trendIndicator.className = 'badge bg-success';
                trendIndicator.innerHTML = '<i class="fas fa-arrow-up me-1"></i> Improving Trend';
            } else if (trend < -0.1) {
                trendIndicator.className = 'badge bg-danger';
                trendIndicator.innerHTML = '<i class="fas fa-arrow-down me-1"></i> Declining Trend';
            } else {
                trendIndicator.className = 'badge bg-secondary';
                trendIndicator.innerHTML = '<i class="fas fa-equals me-1"></i> Neutral Trend';
            }
        }
    }
    
    function updateThemesList(themesData) {
        const themesList = document.getElementById('themes-list');
        
        // Clear current list
        themesList.innerHTML = '';
        
        // If no data, show message
        if (!themesData || themesData.length === 0) {
            themesList.innerHTML = '<div class="alert alert-info">No themes available</div>';
            return;
        }
        
        // Add top 8 themes to list
        themesData.slice(0, 8).forEach(theme => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            
            const themeName = theme.theme || theme.topic || 'Unknown';
            const themeCount = theme.count || theme.importance || 0;
            
            item.innerHTML = `
                <div>
                    <span class="fw-bold">${themeName}</span>
                </div>
                <span class="badge bg-primary rounded-pill">${themeCount}</span>
            `;
            
            themesList.appendChild(item);
        });
    }
    
    function updateThemeSentimentTable(sentimentByThemeData) {
        const tableBody = document.querySelector('#theme-sentiment-table tbody');
        
        // Clear current table
        tableBody.innerHTML = '';
        
        // If no data, show message
        if (!sentimentByThemeData || sentimentByThemeData.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="3" class="text-center">No data available</td>`;
            tableBody.appendChild(row);
            return;
        }
        
        // Add themes to table
        sentimentByThemeData.forEach(item => {
            const row = document.createElement('tr');
            
            const themeName = item.theme || 'Unknown';
            const sentiment = item.sentiment || 0;
            const count = item.count || '-';
            
            // Set row color based on sentiment
            if (sentiment > 0.2) {
                row.className = 'table-success';
            } else if (sentiment < -0.2) {
                row.className = 'table-danger';
            }
            
            // Create sentiment badge
            let badgeClass = 'bg-secondary';
            let sentimentText = 'Neutral';
            
            if (sentiment > 0.3) {
                badgeClass = 'bg-success';
                sentimentText = 'Positive';
            } else if (sentiment > 0) {
                badgeClass = 'bg-info';
                sentimentText = 'Slightly Positive';
            } else if (sentiment > -0.3) {
                badgeClass = 'bg-warning';
                sentimentText = 'Slightly Negative';
            } else {
                badgeClass = 'bg-danger';
                sentimentText = 'Negative';
            }
            
            row.innerHTML = `
                <td>${themeName}</td>
                <td>${count}</td>
                <td>
                    <span class="badge ${badgeClass}">${sentimentText}</span>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
    }
    
    // Initialize empty sections with appropriate placeholders
    function initializeEmptySections() {
        // Initialize Questions section
        const questionsContainer = document.getElementById('questions-container');
        if (questionsContainer && !questionsContainer.innerHTML.trim()) {
            questionsContainer.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No question data available for the selected time period.
                </div>
            `;
        }
        
        // Initialize Concerns section
        const concernsContainer = document.getElementById('concerns-container');
        if (concernsContainer && !concernsContainer.innerHTML.trim()) {
            concernsContainer.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No concern data available for the selected time period.
                    </div>
                `;
        }
        
        // Initialize Positive Interactions section
        const positiveContainer = document.getElementById('positive-interactions-container');
        if (positiveContainer && !positiveContainer.innerHTML.trim()) {
            positiveContainer.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No positive interaction data available for the selected time period.
                </div>
            `;
        }
    }
    
    // Update common questions section with data
    function updateCommonQuestions(questionsData) {
        console.log('Updating common questions with data:', questionsData);
        const container = document.getElementById('questions-container');
        
        // Clear current content
        container.innerHTML = '';
        
        // Create accordion for questions
        const accordionId = 'questionsAccordion';
        const accordion = document.createElement('div');
        accordion.className = 'accordion';
        accordion.id = accordionId;
        
        // Add each question category to the accordion
        questionsData.forEach((category, index) => {
            const categoryId = `question-category-${index}`;
            const headerId = `question-heading-${index}`;
            const collapseId = `question-collapse-${index}`;
            
            const item = document.createElement('div');
            item.className = 'accordion-item';
            
            // Get category name and count
            const categoryName = category.category || 'Question Category';
            const count = category.count || 0;
            const examples = category.examples || [];
            
            // Check if we need scrolling (more than 3 examples)
            const needsScroll = examples.length > 3;
            
            // Create header
            item.innerHTML = `
                <h2 class="accordion-header" id="${headerId}">
                    <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                            aria-expanded="${index === 0 ? 'true' : 'false'}" aria-controls="${collapseId}">
                        ${categoryName} <span class="badge bg-primary ms-2">${count}</span>
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                     aria-labelledby="${headerId}" data-bs-parent="#${accordionId}">
                    <div class="accordion-body">
                        <div class="examples-wrapper position-relative" style="max-height: 150px !important; overflow-y: auto !important;">
                            <ul class="list-group list-group-flush ${needsScroll ? 'limited-height-list' : ''}" style="${needsScroll ? 'max-height: 150px !important; overflow-y: auto !important;' : ''}">
                                ${examples.map((example, idx) => `
                                    <li class="list-group-item" style="${idx >= 3 ? '' : ''}">
                                        <i class="fas fa-quote-left text-muted me-2 small"></i>
                                        ${example.text || 'No text available'}
                                        <div class="small text-muted mt-1">
                                            Conversation ID: 
                                            <a href="#" class="conversation-link" 
                                               data-conversation-id="${example.conversation_id || 'unknown'}"
                                               data-highlight-text="${example.text ? example.text.replace(/"/g, '&quot;') : ''}">${example.conversation_id || 'unknown'}</a>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                            ${needsScroll ? '<div class="scroll-indicator"><i class="fas fa-chevron-down"></i></div>' : ''}
                        </div>
                    </div>
                </div>
            `;
            
            accordion.appendChild(item);
        });
        
        container.appendChild(accordion);
        
        // Add event listeners to conversation links and enforce height limits after rendering
        setTimeout(() => {
            // Enforce height limits programmatically
            document.querySelectorAll('.examples-wrapper').forEach(wrapper => {
                wrapper.style.maxHeight = '150px';
                wrapper.style.overflowY = 'auto';
            });
            
            document.querySelectorAll('.limited-height-list').forEach(list => {
                list.style.maxHeight = '150px';
                list.style.overflowY = 'auto';
            });
            
            document.querySelectorAll('.conversation-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const conversationId = this.getAttribute('data-conversation-id');
                    const highlightText = this.getAttribute('data-highlight-text');
                    if (conversationId && conversationId !== 'unknown') {
                        showConversationModal(conversationId, highlightText);
                    }
                });
            });
            
            // Remove scroll indicators after user has scrolled
            document.querySelectorAll('.examples-wrapper, .limited-height-list').forEach(container => {
                container.addEventListener('scroll', function() {
                    const indicator = this.closest('.examples-wrapper').querySelector('.scroll-indicator');
                    if (indicator) {
                        setTimeout(() => {
                            indicator.style.opacity = '0';
                            setTimeout(() => {
                                indicator.remove();
                            }, 500);
                        }, 1000);
                    }
                });
            });
        }, 100);
    }
    
    // Update concerns and skepticism section with data
    function updateConcernsSkepticism(concernsData) {
        console.log('Updating concerns/skepticism with data:', concernsData);
        const container = document.getElementById('concerns-container');
        
        // Clear current content
        container.innerHTML = '';
        
        // If we have concerns data
        if (concernsData.length > 0) {
            // Create content
            const concernsList = document.createElement('div');
            concernsList.className = 'list-group scrollable-dropdown';
            
            // Add each concern category
            concernsData.forEach(concern => {
                const concernType = concern.type || 'Unknown';
                const count = concern.count || 0;
                const examples = concern.examples || [];
                
                // Check if we need scrolling for examples (more than 3 examples)
                const needsScroll = examples.length > 3;
                
                const item = document.createElement('div');
                item.className = 'list-group-item';
                
                // Create header
                const header = document.createElement('div');
                header.className = 'd-flex justify-content-between align-items-center mb-2';
                header.innerHTML = `
                    <h6 class="mb-0 text-primary">${concernType}</h6>
                    <span class="badge bg-primary rounded-pill">${count}</span>
                `;
                
                item.appendChild(header);
                
                // Add examples if available
                if (examples.length > 0) {
                    const examplesWrapper = document.createElement('div');
                    examplesWrapper.className = 'examples-wrapper position-relative';
                    examplesWrapper.style.maxHeight = '150px';
                    examplesWrapper.style.overflowY = 'auto';
                    
                    const examplesList = document.createElement('div');
                    examplesList.className = `small ${needsScroll ? 'limited-height-list' : ''}`;
                    if (needsScroll) {
                        examplesList.style.maxHeight = '150px';
                        examplesList.style.overflowY = 'auto';
                    }
                    
                    // Only show first 3 examples by default, then add remaining examples
                    const visibleExamples = examples.slice(0, 3);
                    const hiddenExamples = examples.slice(3);
                    
                    // Add the first 3 examples
                    visibleExamples.forEach((example, idx) => {
                        const exampleItem = document.createElement('div');
                        exampleItem.className = 'concern-example';
                        exampleItem.innerHTML = `
                            <div class="fst-italic">"${example.text || 'No text'}"</div>
                            <div class="text-muted small">
                                Conversation ID: 
                                <a href="#" class="conversation-link" 
                                   data-conversation-id="${example.conversation_id || 'unknown'}"
                                   data-highlight-text="${example.text ? example.text.replace(/"/g, '&quot;') : ''}">${example.conversation_id || 'unknown'}</a>
                            </div>
                        `;
                        examplesList.appendChild(exampleItem);
                    });
                    
                    // Add the rest in a scrollable area if needed
                    if (needsScroll) {
                        hiddenExamples.forEach(example => {
                            const exampleItem = document.createElement('div');
                            exampleItem.className = 'concern-example';
                            exampleItem.innerHTML = `
                                <div class="fst-italic">"${example.text || 'No text'}"</div>
                                <div class="text-muted small">
                                    Conversation ID: 
                                    <a href="#" class="conversation-link" 
                                       data-conversation-id="${example.conversation_id || 'unknown'}"
                                       data-highlight-text="${example.text ? example.text.replace(/"/g, '&quot;') : ''}">${example.conversation_id || 'unknown'}</a>
                                </div>
                            `;
                            examplesList.appendChild(exampleItem);
                        });
                        
                        // Add scroll indicator
                        const scrollIndicator = document.createElement('div');
                        scrollIndicator.className = 'scroll-indicator';
                        scrollIndicator.innerHTML = '<i class="fas fa-chevron-down"></i>';
                        examplesWrapper.appendChild(scrollIndicator);
                    }
                    
                    examplesWrapper.appendChild(examplesList);
                    item.appendChild(examplesWrapper);
                }
                
                concernsList.appendChild(item);
            });
            
            container.appendChild(concernsList);
            
            // Add event listeners to conversation links
            setTimeout(() => {
                // Enforce height limits programmatically
                document.querySelectorAll('.examples-wrapper').forEach(wrapper => {
                    wrapper.style.maxHeight = '150px';
                    wrapper.style.overflowY = 'auto';
                });
                
                document.querySelectorAll('.limited-height-list').forEach(list => {
                    list.style.maxHeight = '150px';
                    list.style.overflowY = 'auto';
                });
                
                document.querySelectorAll('.conversation-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const conversationId = this.getAttribute('data-conversation-id');
                        const highlightText = this.getAttribute('data-highlight-text');
                        if (conversationId && conversationId !== 'unknown') {
                            showConversationModal(conversationId, highlightText);
                        }
                    });
                });
                
                // Remove scroll indicators after user has scrolled
                document.querySelectorAll('.examples-wrapper, .limited-height-list').forEach(container => {
                    container.addEventListener('scroll', function() {
                        const indicator = this.closest('.examples-wrapper').querySelector('.scroll-indicator');
                        if (indicator) {
                            setTimeout(() => {
                                indicator.style.opacity = '0';
                                setTimeout(() => {
                                    indicator.remove();
                                }, 500);
                            }, 1000);
                        }
                    });
                });
            }, 100);
        } else {
            // Show empty state
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No concern or skepticism data available for the selected time period.
                </div>
            `;
        }
    }
    
    // Update positive interactions section with data
    function updatePositiveInteractions(interactionsData) {
        console.log('Updating positive interactions with data:', interactionsData);
        const container = document.getElementById('positive-interactions-container');
        
        // Update the count badge
        const countElement = document.getElementById('positive-interactions-count');
        if (countElement) {
            countElement.textContent = interactionsData.length;
        }
        
        // Clear current content
        container.innerHTML = '';
        
        // If we have interactions data
        if (interactionsData.length > 0) {
            // Create timeline style list
            const timeline = document.createElement('div');
            timeline.className = 'position-relative';
            
            // Create timeline line
            const timelineLine = document.createElement('div');
            timelineLine.className = 'position-absolute h-100';
            timelineLine.style = 'width: 2px; background-color: #e9ecef; left: 20px; top: 0;';
            timeline.appendChild(timelineLine);
            
            // Create scrollable container if we have more than 5 items
            const scrollContainer = document.createElement('div');
            if (interactionsData.length > 5) {
                scrollContainer.style.maxHeight = '450px'; // Height to show approximately 5 items
                scrollContainer.style.overflowY = 'auto';
                scrollContainer.style.position = 'relative';
                
                // Add scroll indicators if more than 5 items
                const scrollIndicator = document.createElement('div');
                scrollIndicator.className = 'scroll-indicator-bottom';
                scrollIndicator.innerHTML = '<i class="fas fa-chevron-down"></i>';
                scrollIndicator.style.position = 'absolute';
                scrollIndicator.style.bottom = '0';
                scrollIndicator.style.left = '50%';
                scrollIndicator.style.transform = 'translateX(-50%)';
                scrollIndicator.style.backgroundColor = 'rgba(255,255,255,0.8)';
                scrollIndicator.style.padding = '5px 10px';
                scrollIndicator.style.borderRadius = '15px';
                scrollIndicator.style.boxShadow = '0 0 10px rgba(0,0,0,0.1)';
                scrollIndicator.style.zIndex = '10';
                scrollIndicator.style.opacity = '0.8';
                
                // Add event listeners to show/hide scroll indicators based on scroll position
                scrollContainer.addEventListener('scroll', function() {
                    const isScrolledToBottom = this.scrollHeight - this.scrollTop - this.clientHeight < 10;
                    scrollIndicator.style.display = isScrolledToBottom ? 'none' : 'block';
                });
                
                container.appendChild(scrollIndicator);
            }
            
            // Add each interaction
            interactionsData.forEach(interaction => {
                const item = document.createElement('div');
                item.className = 'position-relative mb-4 ms-4 ps-3';
                
                // Create timeline dot
                const dot = document.createElement('div');
                dot.className = 'position-absolute rounded-circle bg-success';
                dot.style = 'width: 12px; height: 12px; left: -28px; top: 6px;';
                
                item.appendChild(dot);
                
                // For positive interactions, highlight the caller's response which is the positive part
                const highlightText = interaction.caller_response || '';
                
                // Create content
                item.innerHTML += `
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="mb-2 text-muted small">Lily said:</div>
                            <div class="mb-3 ps-2 border-start border-primary">
                                ${interaction.lily_prompt || 'No data available'}
                            </div>
                            <div class="mb-2 text-success small">Caller responded:</div>
                            <div class="mb-2 ps-2 border-start border-success fw-bold">
                                ${interaction.caller_response || 'No data available'}
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <span class="text-muted small">
                                    Conversation ID: 
                                    <a href="#" class="conversation-link" 
                                       data-conversation-id="${interaction.conversation_id || 'unknown'}"
                                       data-highlight-text="${highlightText.replace(/"/g, '&quot;')}">${interaction.conversation_id || 'unknown'}</a>
                                </span>
                                <span class="badge bg-success">
                                    ${(interaction.sentiment_score || 0).toFixed(2)} 
                                    <i class="fas fa-smile ms-1"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                
                timeline.appendChild(item);
            });
            
            // Add the timeline to the scroll container if we have many items, or directly to main container
            if (interactionsData.length > 5) {
                scrollContainer.appendChild(timeline);
                container.appendChild(scrollContainer);
            } else {
                container.appendChild(timeline);
            }
            
            // Add event listeners to conversation links
            setTimeout(() => {
                document.querySelectorAll('.conversation-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const conversationId = this.getAttribute('data-conversation-id');
                        const highlightText = this.getAttribute('data-highlight-text');
                        if (conversationId && conversationId !== 'unknown') {
                            showConversationModal(conversationId, highlightText);
                        }
                    });
                });
            }, 100);
        } else {
            // Show empty state
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No positive interaction data available for the selected time period.
                </div>
            `;
        }
    }
</script>
{% endblock %} 