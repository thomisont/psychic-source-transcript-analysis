{% extends "base.html" %}

{% block title %}Engagement Metrics - Psychic Source Analyzer{% endblock %}

{% block styles %}
<style>
    /* Button pulse effect for feedback */
    .btn-pulse {
        animation: btn-pulse 0.3s ease-in-out;
    }
    @keyframes btn-pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.3); }
        50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 193, 7, 0.3); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.3); }
    }
    
    /* Transitions for smoother updates */
    .card-body {
        transition: opacity 0.2s ease-in-out;
    }
    
    /* Make active buttons more prominent */
    .btn-warning.active {
        font-weight: bold;
        box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.5);
    }
    
    /* Timeframe selector spacing */
    .timeframe-selector {
        margin-right: 2px;
    }
    
    /* Ensure card content is always visible */
    .card-body canvas {
        max-height: 200px;
    }
    
    /* Style for loading overlay */
    #loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 100;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    /* Make sure visualization content doesn't get too dimmed */
    #visualization-content.opacity-25 {
        opacity: 0.5 !important;
    }
    
    /* Fix contrast issue with timeframe selectors */
    .btn-outline-light {
        border-color: #fff;
        color: #fff;
        font-weight: normal;
    }
    
    .btn-outline-light:hover {
        background-color: rgba(255, 255, 255, 0.2);
        color: #fff;
    }
    
    .btn-warning.active {
        border-color: #fff;
    }
    
    /* Better styling for count indicators */
    .count-indicators {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .count-box {
        padding: 10px;
        border-radius: 8px;
        margin-right: 10px;
    }
    
    .count-box .count-icon {
        font-size: 1.8rem;
        color: var(--bs-primary);
        margin-right: 10px;
    }
    
    .count-box .count-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    
    .count-box .count-label {
        font-size: 0.9rem;
        color: var(--bs-secondary);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Engagement Metrics
                </h5>
                <div class="d-flex align-items-center">
                    <div class="btn-group me-2" role="group" aria-label="Date range selection">
                        <button type="button" class="btn btn-outline-light timeframe-selector" data-timeframe="last_7_days">7 Days</button>
                        <button type="button" class="btn btn-warning timeframe-selector active" data-timeframe="last_30_days">30 Days</button>
                        <button type="button" class="btn btn-outline-light timeframe-selector" data-timeframe="last_90_days">90 Days</button>
                        <button type="button" class="btn btn-outline-light timeframe-selector" data-timeframe="all_time">All</button>
                    </div>
                    <button type="button" class="btn btn-outline-light px-3" data-bs-toggle="modal" data-bs-target="#filterModal">
                        <i class="fas fa-calendar-alt me-1"></i>Custom Range
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Add date range indicator -->
                <div id="date-range-indicator" class="alert alert-info mb-3 py-2">
                    <small><strong>Current date range:</strong> <span id="current-date-range">Last 30 days</span></small>
                    <span class="float-end" id="aggregation-note" style="display: none;">
                        <i class="fas fa-info-circle"></i> Time of Day and Day of Week charts show aggregated patterns across the selected time period.
                    </span>
                </div>
                
                <!-- Improved count indicators -->
                <div class="count-indicators mb-4">
                    <div class="row">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body d-flex align-items-center p-4">
                                    <div class="stats-icon bg-primary text-white rounded-circle p-3 me-4 d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                                        <i class="fas fa-phone-alt fa-2x"></i>
                                    </div>
                                    <div>
                                        <h6 class="text-muted mb-1">Calls in Selected Period</h6>
                                        <h1 class="display-5 fw-bold mb-0" id="total-calls-count">0</h1>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body d-flex align-items-center p-4">
                                    <div class="stats-icon bg-info text-white rounded-circle p-3 me-4 d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                                        <i class="fas fa-database fa-2x"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="text-muted mb-1">Total Conversations in Database</h6>
                                        <div class="d-flex align-items-center">
                                            <h1 class="display-5 fw-bold mb-0" id="total-conversations-count">0</h1>
                                            <button id="refresh-total" class="btn btn-sm btn-primary rounded-circle ms-3" title="Refresh count" style="width: 36px; height: 36px;">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="loading-overlay" class="d-none" style="position: absolute; top: 50px; left: 0; right: 0; bottom: 0; z-index: 1000;">
                    <div class="d-flex justify-content-center align-items-center p-5">
                        <div class="spinner-border text-primary me-3" role="status"></div>
                        <h5 class="mb-0">Loading data...</h5>
                    </div>
                </div>
                <div id="visualization-content">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Conversation Volume</h5>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px;">
                                        <canvas id="volumeChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Average Duration</h5>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px;">
                                        <canvas id="durationChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Time of Day Distribution</h5>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px;">
                                        <canvas id="timeOfDayChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Day of Week Distribution</h5>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px;">
                                        <canvas id="dayOfWeekChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Completion Rate</h5>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px;">
                                        <canvas id="completionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Custom Date Range</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="visualization-filter-form">
                    <div class="mb-3">
                        <label for="viz-start-date" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="viz-start-date" name="start_date">
                    </div>
                    <div class="mb-3">
                        <label for="viz-end-date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="viz-end-date" name="end_date">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="apply-filter-button">Apply Filters</button>
            </div>
        </div>
    </div>
</div>

<!-- Debug panel (hidden by default) -->
<div id="debug-panel" class="position-fixed bottom-0 end-0 p-3 bg-dark text-light" style="max-width: 400px; display: none; max-height: 300px; overflow-y: auto; z-index: 1050; opacity: 0.9;">
    <div class="d-flex justify-content-between mb-2">
        <h6 class="m-0">Debug Information</h6>
        <button id="close-debug" class="btn btn-sm btn-outline-light p-0 px-1">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div id="debug-content" class="small">
        <div>Press Alt+D to toggle this panel</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let visualizationCharts = {};
    
    // Debug utilities
    let debugLines = [];
    function logDebug(message) {
        const timestamp = new Date().toLocaleTimeString();
        debugLines.push(`[${timestamp}] ${message}`);
        
        // Keep only the last 50 lines
        if (debugLines.length > 50) {
            debugLines = debugLines.slice(-50);
        }
        
        // Update debug panel if it's visible
        const debugContent = document.getElementById('debug-content');
        if (debugContent && document.getElementById('debug-panel').style.display !== 'none') {
            debugContent.innerHTML = debugLines.map(line => `<div>${line}</div>`).join('');
            // Scroll to bottom
            debugContent.scrollTop = debugContent.scrollHeight;
        }
    }

    // Function to fetch total conversations count
    function fetchTotalConversations() {
        const totalElement = document.getElementById('total-conversations-count');
        const refreshButton = document.getElementById('refresh-total');
        if (!totalElement) return;
        
        totalElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        if (refreshButton) {
            refreshButton.innerHTML = '<i class="fas fa-sync fa-spin"></i>';
            refreshButton.disabled = true;
        }
        
        // Add more robust cache-busting parameters - timestamp plus random value
        const timestamp = new Date().getTime();
        const randomValue = Math.floor(Math.random() * 1000000);
        const cacheBuster = `${timestamp}-${randomValue}`;
        
        // Force a completely fresh request
        fetch(`/api/total_conversations?_=${cacheBuster}`, {
            method: 'GET',
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0',
                'X-Cache-Bust': timestamp.toString() // Add another cache-busting header
            },
            // Add cache: 'no-store' to force fresh network request
            cache: 'no-store'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Total conversations data:', data);
                // Display the actual count returned by the API
                totalElement.textContent = data.total.toLocaleString();
                logDebug(`Total conversations in database: ${data.total}`);
                
                // Restore refresh button
                if (refreshButton) {
                    refreshButton.innerHTML = '<i class="fas fa-sync"></i>';
                    refreshButton.disabled = false;
                    
                    // Add visual feedback for successful refresh
                    refreshButton.classList.add('btn-success');
                    refreshButton.classList.remove('btn-primary');
                    setTimeout(() => {
                        refreshButton.classList.remove('btn-success');
                        refreshButton.classList.add('btn-primary');
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Error fetching total conversations:', error);
                totalElement.textContent = 'Error';
                
                // Restore refresh button
                if (refreshButton) {
                    refreshButton.innerHTML = '<i class="fas fa-sync"></i>';
                    refreshButton.disabled = false;
                    
                    // Add visual feedback for error
                    refreshButton.classList.add('btn-danger');
                    refreshButton.classList.remove('btn-primary');
                    setTimeout(() => {
                        refreshButton.classList.remove('btn-danger');
                        refreshButton.classList.add('btn-primary');
                    }, 1000);
                }
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log('Visualization page ready - setting up timeframe selectors');
        
        // Get all timeframe selectors
        const timeframeSelectors = document.querySelectorAll('.timeframe-selector');
        console.log(`Found ${timeframeSelectors.length} timeframe selectors`);
        
        // Load total conversations count
        fetchTotalConversations();
        
        // Set up auto-refresh for total conversations (every 30 seconds)
        const REFRESH_INTERVAL = 30 * 1000; // 30 seconds in milliseconds
        const autoRefreshTimer = setInterval(() => {
            logDebug('Auto-refreshing total conversations count');
            
            // Add subtle visual feedback for auto-refresh
            const totalElement = document.getElementById('total-conversations-count');
            if (totalElement) {
                totalElement.style.transition = 'opacity 0.3s ease-in-out';
                totalElement.style.opacity = '0.5';
                setTimeout(() => {
                    totalElement.style.opacity = '1';
                }, 300);
            }
            
            fetchTotalConversations();
        }, REFRESH_INTERVAL);
        
        // Set up refresh button
        document.getElementById('refresh-total').addEventListener('click', function(e) {
            e.preventDefault();
            fetchTotalConversations();
        });
        
        // Set up debug panel toggle
        document.addEventListener('keydown', function(e) {
            // Alt+D to toggle debug panel
            if (e.altKey && e.key === 'd') {
                const debugPanel = document.getElementById('debug-panel');
                if (debugPanel.style.display === 'none') {
                    debugPanel.style.display = 'block';
                    // Update content
                    const debugContent = document.getElementById('debug-content');
                    debugContent.innerHTML = debugLines.map(line => `<div>${line}</div>`).join('');
                    // Scroll to bottom
                    debugContent.scrollTop = debugContent.scrollHeight;
                } else {
                    debugPanel.style.display = 'none';
                }
            }
        });
        
        // Set up close button for debug panel
        document.getElementById('close-debug').addEventListener('click', function() {
            document.getElementById('debug-panel').style.display = 'none';
        });
        
        // Set default date range (last 30 days)
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 30);
        
        document.getElementById('viz-start-date').value = startDate.toISOString().split('T')[0];
        document.getElementById('viz-end-date').value = endDate.toISOString().split('T')[0];
        
        // Style the active button correctly on page load
        const activeButton = document.querySelector('.timeframe-selector.active');
        if (activeButton) {
            activeButton.classList.add('active');
            activeButton.classList.remove('btn-outline-light');
            activeButton.classList.add('btn-warning');
            activeButton.style.fontWeight = 'bold';
            
            // Set initial date range text
            document.getElementById('current-date-range').textContent = 'Last 30 days';
        }
        
        // Load initial visualization data with default timeframe
        loadVisualizationData('last_30_days');
        
        // Set up event listeners for timeframe buttons
        timeframeSelectors.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Only perform action if this button is not already active
                if (!this.classList.contains('active')) {
                    const timeframe = this.getAttribute('data-timeframe');
                    console.log('Timeframe button clicked:', timeframe);
                    logDebug(`Timeframe selector clicked: ${timeframe}`);
                    
                    // Show visual pulse for feedback
                    this.classList.add('btn-pulse');
                    setTimeout(() => {
                        this.classList.remove('btn-pulse');
                    }, 300);
                    
                    // First deactivate all buttons
                    timeframeSelectors.forEach(btn => {
                        btn.classList.remove('active');
                        btn.classList.remove('btn-warning');
                        btn.style.fontWeight = 'normal';
                        btn.classList.add('btn-outline-light');
                        btn.style.opacity = '0.8';
                    });
                    
                    // Then activate only this button
                    this.classList.add('active');
                    this.classList.remove('btn-outline-light');
                    this.classList.add('btn-warning');
                    this.style.fontWeight = 'bold';
                    this.style.opacity = '1';
                    
                    // Update date range text
                    const timeframeText = {
                        'last_7_days': 'Last 7 days',
                        'last_30_days': 'Last 30 days',
                        'last_90_days': 'Last 90 days',
                        'all_time': 'All time (since Jan 2025)'
                    };
                    document.getElementById('current-date-range').textContent = timeframeText[timeframe];
                    
                    // Add loading indicator to cards
                    document.querySelectorAll('.card-body').forEach(card => {
                        card.style.opacity = '0.6';
                    });
                    
                    // Force a refresh of the total conversations count
                    fetchTotalConversations();
                    
                    // Load data after a brief delay for visual feedback
                    setTimeout(() => {
                        loadVisualizationData(timeframe);
                    }, 100);
                }
            });
        });
        
        // Set up event listener for custom filter button
        document.getElementById('apply-filter-button').addEventListener('click', function(e) {
            e.preventDefault();
            
            const startDate = document.getElementById('viz-start-date').value;
            const endDate = document.getElementById('viz-end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates.');
                return;
            }
            
            // Validate date range
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            
            if (startDateObj > endDateObj) {
                alert('Start date cannot be after end date.');
                return;
            }
            
            // Format dates for display
            const formattedStartDate = startDateObj.toLocaleDateString();
            const formattedEndDate = endDateObj.toLocaleDateString();
            
            // Update date range text
            document.getElementById('current-date-range').textContent = 
                `Custom: ${formattedStartDate} to ${formattedEndDate}`;
            
            // Deactivate all timeframe buttons
            timeframeSelectors.forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('btn-warning');
                btn.style.fontWeight = 'normal';
                btn.classList.add('btn-outline-light');
                btn.style.opacity = '0.8';
            });
            
            // Hide modal
            const modal = document.getElementById('filterModal');
            const modalInstance = bootstrap.Modal.getInstance(modal);
            if (modalInstance) {
                modalInstance.hide();
            }
            
            // Add loading indicator to cards
            document.querySelectorAll('.card-body').forEach(card => {
                card.style.opacity = '0.6';
            });
            
            // Force a refresh of the total conversations count
            fetchTotalConversations();
            
            // Load data after a brief delay for visual feedback
            setTimeout(() => {
                loadVisualizationData('custom', startDate, endDate);
            }, 100);
        });
    });
    
    function loadVisualizationData(timeframe, customStartDate, customEndDate) {
        // Show loading overlay
        document.getElementById('loading-overlay').classList.remove('d-none');
        document.getElementById('visualization-content').classList.add('opacity-25');
        document.getElementById('total-calls-count').textContent = '...';
        
        // Reset card opacity to ensure it's visible
        document.querySelectorAll('.card-body').forEach(card => {
            card.style.opacity = '1';
        });
        
        // Log our inputs
        console.log('Loading visualization data with timeframe:', timeframe);
        console.log('Custom start date:', customStartDate);
        console.log('Custom end date:', customEndDate);
        logDebug(`Loading visualization data: timeframe=${timeframe}, custom dates=${customStartDate} to ${customEndDate}`);
        
        // Calculate date range for any timeframe
        let startDate, endDate;
        const today = new Date();
        endDate = new Date(today);
        endDate.setHours(23, 59, 59, 999); // End of today
        
        if (timeframe === 'custom' && customStartDate && customEndDate) {
            startDate = new Date(customStartDate);
            endDate = new Date(customEndDate);
            endDate.setHours(23, 59, 59, 999); // End of the day for end date
            
            // Show aggregation note for all date ranges
            document.getElementById('aggregation-note').style.display = 'inline';
        } else {
            // Calculate start date based on timeframe
            startDate = new Date(today);
            startDate.setHours(0, 0, 0, 0); // Start of today
            
            if (timeframe === 'last_7_days') {
                startDate.setDate(startDate.getDate() - 7);
            } else if (timeframe === 'last_30_days') {
                startDate.setDate(startDate.getDate() - 30);
            } else if (timeframe === 'last_90_days') {
                startDate.setDate(startDate.getDate() - 90);
            } else if (timeframe === 'all_time') {
                // Set start date to January 1, 2020 for "all time"
                startDate = new Date(2020, 0, 1); // Month is 0-indexed in JavaScript
                logDebug('Using all_time timeframe with start date Jan 1, 2020');
            }
            
            // Show aggregation note for all date ranges
            document.getElementById('aggregation-note').style.display = 'inline';
        }
        
        console.log('Calculated date range:', startDate, 'to', endDate);
        logDebug(`Calculated date range: ${startDate.toISOString().split('T')[0]} to ${endDate.toISOString().split('T')[0]}`);
        
        // Build query parameters
        let url = '/api/visualization/data';
        const params = new URLSearchParams();
        
        if (timeframe === 'custom' && customStartDate && customEndDate) {
            params.append('start_date', customStartDate);
            params.append('end_date', customEndDate);
        } else if (timeframe) {
            params.append('timeframe', timeframe);
        }
        
        if (params.toString()) {
            url += `?${params.toString()}`;
        }
        
        console.log('Fetching data with URL:', url);
        logDebug(`Fetching visualization data from: ${url}`);
        
        // Set a longer timeout for slower connections
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000); // 20 second timeout
        
        // Make API request to get visualization data with cache-busting and timeout
        fetch(url, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache'
            },
            signal: controller.signal
        })
        .then(response => {
            clearTimeout(timeoutId); // Clear the timeout
            if (!response.ok) {
                return response.json().then(errData => {
                    const errorMsg = errData.error || `HTTP error ${response.status}`;
                    console.error(`API Error ${response.status}:`, errorMsg);
                    throw new Error(errorMsg); 
                }).catch(() => {
                    console.error(`HTTP error ${response.status}`);
                    throw new Error(`HTTP error ${response.status}`);
                });
            }
            return response.json();
        })
        .then(metrics_data => {
            console.log('Received visualization metrics:', metrics_data);
            
            // Restore card opacity
            document.querySelectorAll('.card-body').forEach(card => {
                card.style.opacity = '1';
            });
            
            // Check if there's an error message in the response
            if (metrics_data.error) {
                console.error('Error in API response:', metrics_data.error);
                document.getElementById('visualization-content').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        API Error: ${metrics_data.error}
                    </div>
                `;
                document.getElementById('total-calls-count').textContent = '0';
            } else {
                // Log data details for debugging
                if (metrics_data.volume && metrics_data.volume.labels) {
                    logDebug(`Received volume data with ${metrics_data.volume.labels.length} points.`);
                }
                
                // Update the date range indicator with the actual dates used by the service
                const actualRange = metrics_data.date_range;
                if (actualRange && actualRange.start_date && actualRange.end_date) {
                    const startDisplay = new Date(actualRange.start_date + 'T00:00:00Z').toLocaleDateString(); // Assume UTC
                    const endDisplay = new Date(actualRange.end_date + 'T00:00:00Z').toLocaleDateString(); // Assume UTC
                    let rangeText = '';
                    if (timeframe && timeframe !== 'custom') {
                        const timeframeMap = {
                            'last_7_days': 'Last 7 days',
                            'last_30_days': 'Last 30 days',
                            'last_90_days': 'Last 90 days',
                            'all_time': 'All time'
                        }
                        rangeText = `${timeframeMap[timeframe] || 'Selected Period'}: ${startDisplay} to ${endDisplay}`;
                    } else {
                        rangeText = `Custom Range: ${startDisplay} to ${endDisplay}`;
                    }
                    document.getElementById('current-date-range').textContent = rangeText;
                    logDebug(`Displaying metrics for actual range: ${actualRange.start_date} to ${actualRange.end_date}`);
                } else {
                     document.getElementById('current-date-range').textContent = 'Date range unknown';
                }

                // Validate essential data exists before trying to create charts
                // Check if volume data specifically is present and has entries
                const hasVolumeData = metrics_data.volume && metrics_data.volume.labels && metrics_data.volume.labels.length > 0 && metrics_data.volume.data && metrics_data.volume.data.length > 0;

                if (!hasVolumeData) {
                    console.warn('No volume data available for the selected period.');
                    document.getElementById('visualization-content').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No conversation data available for the selected date range. Please try a different range or sync new conversations.
                        </div>
                    `;
                    document.getElementById('total-calls-count').textContent = '0'; // Set count to 0
                } else {
                    // If volume data exists, proceed to create visualizations
                    // The createVisualizations function will handle empty states for individual charts
                    createVisualizations(metrics_data);
                }
            }
            
            // Hide loading overlay regardless of success or error (unless specific error handling shows message)
            document.getElementById('loading-overlay').classList.add('d-none');
            document.getElementById('visualization-content').classList.remove('opacity-25');
        })
        .catch(error => {
            clearTimeout(timeoutId); // Clear the timeout
            console.error('Error fetching visualization data:', error);
            logDebug(`Error: ${error.message}`);
            
            // Restore card opacity
            document.querySelectorAll('.card-body').forEach(card => {
                card.style.opacity = '1';
            });
            
            // Show error message in visualization area
            document.getElementById('visualization-content').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Failed to load visualization data: ${error.message}. Please try again.
                </div>
            `;
            
            // Hide loading overlay
            document.getElementById('loading-overlay').classList.add('d-none');
            document.getElementById('visualization-content').classList.remove('opacity-25');
            document.getElementById('total-calls-count').textContent = '0';
        });
    }
    
    function createVisualizations(metrics_data) {
        console.log('Creating visualizations with metrics:', metrics_data);
        logDebug('Rendering visualizations...');
        
        // Calculate total calls from volume data (assume volume data exists based on check in loadVisualizationData)
        const totalCalls = metrics_data.volume.data.reduce((sum, count) => sum + count, 0);
        document.getElementById('total-calls-count').textContent = totalCalls;
        logDebug(`Total calls in period: ${totalCalls}`);

        // Reset content if it was previously showing no data message
        // Ensure the chart canvases exist before trying to draw
        if (!document.getElementById('volumeChart')) {
            console.log('Chart canvases not found, recreating structure.');
            logDebug('Recreating chart canvas structure.');
            // Re-create the basic structure needed for charts
            document.getElementById('visualization-content').innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Conversation Volume</h5>
                            </div>
                            <div class="card-body">
                                <div style="height: 200px;" id="volumeChartContainer">
                                    <canvas id="volumeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Average Duration</h5>
                            </div>
                            <div class="card-body">
                                <div style="height: 200px;" id="durationChartContainer">
                                    <canvas id="durationChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Time of Day Distribution</h5>
                                <small class="text-muted">Aggregated across selected dates</small>
                            </div>
                            <div class="card-body">
                                <div style="height: 200px;" id="timeOfDayChartContainer">
                                    <canvas id="timeOfDayChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Day of Week Distribution</h5>
                                <small class="text-muted">Aggregated across selected dates</small>
                            </div>
                            <div class="card-body">
                                <div style="height: 200px;" id="dayOfWeekChartContainer">
                                    <canvas id="dayOfWeekChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Completion Rate</h5>
                            </div>
                            <div class="card-body">
                                <div style="height: 200px;" id="completionChartContainer">
                                    <canvas id="completionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Create Individual Charts --- 
        // Each function now handles its own empty state.
        
        // Create volume chart (assured to have data from calling function)
        createVolumeChart(metrics_data.volume);
        
        // Create duration chart
        createDurationChart(metrics_data.duration);
        
        // Create time of day distribution chart
        createTimeOfDayChart(metrics_data.time_of_day);
        
        // Create day of week distribution chart
        createDayOfWeekChart(metrics_data.day_of_week);
        
        // Create completion rate chart
        createCompletionChart(metrics_data.completion);
    }
    
    function showEmptyChartState(canvasId, message = 'No data available for this period') {
        const canvas = document.getElementById(canvasId);
        const container = canvas ? canvas.closest('.card-body') : null; // Find parent card body
        if (container) {
            logDebug(`Showing empty state for chart: ${canvasId}`);
            // Use the container's ID if canvas ID includes 'Chart'
            const containerId = canvasId.replace('Chart', 'ChartContainer'); 
            const chartContainer = document.getElementById(containerId);
            if(chartContainer) {
                 chartContainer.innerHTML = `
                    <div class="d-flex flex-column justify-content-center align-items-center h-100 text-muted">
                        <i class="fas fa-chart-bar mb-2" style="font-size: 1.5rem; opacity: 0.5;"></i>
                        <small>${message}</small>
                    </div>
                `;
            } else {
                 container.innerHTML = `
                    <div class="d-flex flex-column justify-content-center align-items-center h-100 text-muted">
                        <i class="fas fa-chart-bar mb-2" style="font-size: 1.5rem; opacity: 0.5;"></i>
                        <small>${message}</small>
                    </div>
                `;
            }
        }
    }

    function createVolumeChart(volumeData) {
        // Destroy existing chart if it exists
        if (visualizationCharts.volumeChart) {
            visualizationCharts.volumeChart.destroy();
            visualizationCharts.volumeChart = null; // Clear reference
        }
        
        const canvas = document.getElementById('volumeChart');
        if (!canvas) {
             console.error('Volume chart canvas not found!');
             logDebug('Error: Volume chart canvas not found!');
             return;
        } 
        const ctx = canvas.getContext('2d');

        // Check for valid data (should always be valid here based on calling function check)
        if (!volumeData || !volumeData.labels || !volumeData.data || volumeData.data.length === 0) {
            console.warn('Volume data missing or empty, showing empty state.');
            showEmptyChartState('volumeChart');
            return;
        }

        logDebug(`Creating volume chart with ${volumeData.labels.length} labels.`);
        const dateRange = volumeData.labels.length;
        
        visualizationCharts.volumeChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: volumeData.labels || [],
                datasets: [{
                    label: 'Number of Conversations',
                    data: volumeData.data || [],
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Allow chart to fill container height
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                // Ensure we show full date in tooltip
                                try {
                                    const date = new Date(tooltipItems[0].label + 'T00:00:00Z'); // Assume UTC
                                    return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
                                } catch (e) {
                                    return tooltipItems[0].label; // Fallback
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            autoSkip: dateRange > 10 // Auto-skip labels if we have more than 10 days
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }

    function createDurationChart(durationData) {
        // Destroy existing chart if it exists
        if (visualizationCharts.durationChart) {
            visualizationCharts.durationChart.destroy();
            visualizationCharts.durationChart = null;
        }

        const canvas = document.getElementById('durationChart');
        if (!canvas) {
             console.error('Duration chart canvas not found!');
             logDebug('Error: Duration chart canvas not found!');
             return;
        } 
        const ctx = canvas.getContext('2d');

        // Check if we have valid data: labels and data arrays must exist and be non-empty
        // Also check if all data points are effectively zero (or null/undefined)
        const hasValidDurationData = durationData && durationData.labels && durationData.data && 
                                   durationData.labels.length > 0 && durationData.data.length > 0 &&
                                   durationData.data.some(val => val !== null && val !== undefined && Number(val) > 0);

        if (!hasValidDurationData) {
            console.warn('Duration data missing, empty, or all zero. Showing empty state.');
            showEmptyChartState('durationChart', 'No duration data available');
            return;
        }
        
        logDebug(`Creating duration chart with ${durationData.labels.length} labels.`);
        // Process data values to ensure they're valid numbers, default nulls/undefined to 0
        const chartDataValues = durationData.data.map(value => {
            const numValue = Number(value);
            return isNaN(numValue) ? 0 : numValue;
        });

        const dateRange = durationData.labels.length;

        visualizationCharts.durationChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: durationData.labels,
                datasets: [{
                    label: 'Average Duration (seconds)',
                    data: chartDataValues, // Use processed values
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const seconds = context.raw;
                                if (typeof seconds !== 'number' || isNaN(seconds)) return 'N/A';
                                const minutes = Math.floor(seconds / 60);
                                const remainingSeconds = Math.round(seconds % 60);
                                return `${minutes}m ${remainingSeconds}s`;
                            },
                            title: function(tooltipItems) {
                                try {
                                    const date = new Date(tooltipItems[0].label + 'T00:00:00Z'); // Assume UTC
                                    return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
                                } catch (e) {
                                    return tooltipItems[0].label; // Fallback
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            autoSkip: dateRange > 10 
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Seconds'
                        }
                    }
                }
            }
        });
    }

    function createTimeOfDayChart(timeOfDayData) {
        if (visualizationCharts.timeOfDayChart) {
            visualizationCharts.timeOfDayChart.destroy();
            visualizationCharts.timeOfDayChart = null;
        }
        
        const canvas = document.getElementById('timeOfDayChart');
         if (!canvas) {
             console.error('Time of day chart canvas not found!');
             logDebug('Error: Time of day chart canvas not found!');
             return;
        } 
        const ctx = canvas.getContext('2d');

        // Check for valid data - needs a data array where at least one value is > 0
        const hasValidTodData = timeOfDayData && timeOfDayData.data && timeOfDayData.data.length === 24 && 
                                timeOfDayData.data.some(val => val !== null && val !== undefined && Number(val) > 0);

        if (!hasValidTodData) {
            console.warn('Time of Day data missing or all zero. Showing empty state.');
            showEmptyChartState('timeOfDayChart', 'No hourly data available');
            return;
        }

        logDebug('Creating time of day chart.');
        // Ensure data is numeric, default non-numbers to 0
        const dataValues = timeOfDayData.data.map(d => Number(d) || 0);
        const maxCount = Math.max(...dataValues, 1); // Avoid division by zero
        const backgroundColor = dataValues.map(count => {
            const ratio = count / maxCount;
            // Ensure alpha is between 0.2 and 1.0
            const alpha = Math.max(0.2, Math.min(1.0, ratio)); 
            return `rgba(153, 102, 255, ${alpha})`;
        });

        visualizationCharts.timeOfDayChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: timeOfDayData.labels || Array.from({length: 24}, (_, i) => `${i}:00`), // Default labels
                datasets: [{
                    label: 'Conversations',
                    data: dataValues, // Use processed data
                    backgroundColor: backgroundColor,
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            autoSkip: true,
                            maxRotation: 0
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }

    function createDayOfWeekChart(dayOfWeekData) {
        if (visualizationCharts.dayOfWeekChart) {
            visualizationCharts.dayOfWeekChart.destroy();
            visualizationCharts.dayOfWeekChart = null;
        }
        
        const canvas = document.getElementById('dayOfWeekChart');
        if (!canvas) {
             console.error('Day of week chart canvas not found!');
             logDebug('Error: Day of week chart canvas not found!');
             return;
        } 
        const ctx = canvas.getContext('2d');

        // Check for valid data - needs data array length 7 with at least one value > 0
        const hasValidDowData = dayOfWeekData && dayOfWeekData.data && dayOfWeekData.data.length === 7 && 
                                dayOfWeekData.data.some(val => val !== null && val !== undefined && Number(val) > 0);

        if (!hasValidDowData) {
            console.warn('Day of Week data missing or all zero. Showing empty state.');
            showEmptyChartState('dayOfWeekChart', 'No daily data available');
            return;
        }

        logDebug('Creating day of week chart.');
        // Ensure data is numeric
        const dataValues = dayOfWeekData.data.map(d => Number(d) || 0);

        visualizationCharts.dayOfWeekChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dayOfWeekData.labels || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], // Default labels
                datasets: [{
                    label: 'Conversations',
                    data: dataValues,
                    backgroundColor: 'rgba(255, 159, 64, 0.5)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                     x: {
                        grid: { display: false } // Cleaner look
                     },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }

    function createCompletionChart(completionData) {
        if (visualizationCharts.completionChart) {
            visualizationCharts.completionChart.destroy();
            visualizationCharts.completionChart = null;
        }
        
        const canvas = document.getElementById('completionChart');
        if (!canvas) {
             console.error('Completion chart canvas not found!');
             logDebug('Error: Completion chart canvas not found!');
             return;
        } 
        const ctx = canvas.getContext('2d');

        // Check for valid data: labels and data arrays must exist and be non-empty
        const hasValidCompletionData = completionData && completionData.labels && completionData.data && 
                                       completionData.labels.length > 0 && completionData.data.length > 0;
        
        if (!hasValidCompletionData) {
            console.warn('Completion data missing or empty. Showing empty state.');
            showEmptyChartState('completionChart', 'No completion data available');
            return;
        }

        logDebug(`Creating completion chart with ${completionData.labels.length} labels.`);
        // Ensure data is numeric, default non-numbers to 0
        const dataValues = completionData.data.map(d => {
             const num = Number(d);
             return isNaN(num) ? 0 : num; // Default invalid rates to 0
        });
        const dateRange = completionData.labels.length;

        visualizationCharts.completionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: completionData.labels,
                datasets: [{
                    label: 'Completion Rate (%)',
                    data: dataValues,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true // Fill area under line
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                return `Rate: ${value.toFixed(1)}%`; // Format percentage
                            },
                             title: function(tooltipItems) {
                                try {
                                    const date = new Date(tooltipItems[0].label + 'T00:00:00Z'); // Assume UTC
                                    return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
                                } catch (e) {
                                    return tooltipItems[0].label; // Fallback
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            autoSkip: dateRange > 10
                        }
                    },
                    y: {
                        min: 0,
                        // Let chart.js determine max based on data, but ensure it's at least a bit above 0
                        // max: 100, 
                        suggestedMax: 100, // Suggest 100 but allow higher if data exceeds
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %} 