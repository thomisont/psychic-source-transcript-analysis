{% extends "base.html" %}

{% block title %}Themes & Sentiment Analysis{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* Opacity transitions removed, JS now handles display: block/none */
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <h1 class="h3">Themes & Sentiment Analysis</h1>
        <div id="date-range-selector" class="btn-group date-filter" role="group" aria-label="Date range options">
            <button type="button" class="btn btn-outline-primary date-range-btn active" data-timeframe="last_7_days">7 Days</button>
            <button type="button" class="btn btn-outline-primary date-range-btn" data-timeframe="last_30_days">30 Days</button>
            <button type="button" class="btn btn-outline-primary date-range-btn" data-timeframe="last_90_days">90 Days</button>
            <button type="button" class="btn btn-outline-primary date-range-btn" data-timeframe="all_time">All</button>
        </div>
    </div>
    <div class="mb-3 text-end" id="conversation-count-display" style="min-height: 20px;">
        <!-- Conversation count will be loaded here -->
    </div>
    <!-- Displays the name of the AI model used for the analysis -->
    <p id="analysis-model-info" class="text-muted small text-end mb-3" style="min-height: 18px;"></p>

    <!-- Enhanced Loading Indicator (display controlled by JS) -->
    <div id="loading-indicator" class="text-center my-5" style="display: none;"> 
        <div class="spinner-border text-primary mb-2" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p id="loading-message-main" class="h5 mb-1">Sentiment Analysis Underway</p>
        <p id="loading-message-detail" class="text-muted small mb-3">This process takes time to complete.</p>
        <div class="progress" style="height: 10px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
        </div>
    </div>

    <!-- Error Display -->
    <div id="error-display" class="alert alert-danger" role="alert" style="display: none;">
        An error occurred while fetching analysis data. Please try again later.
        <span id="error-details" class="small d-block mt-1"></span>
    </div>

    <!-- Main Content Area (display controlled by JS) -->
    <div id="analysis-content" style="display: none;">
        <!-- Row 1: Sentiment Overview & Top Themes -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-heart-pulse-fill me-2"></i>Sentiment Overview</h5>
                    </div>
                    <div class="card-body p-4">
                        <div id="sentiment-overview-content">
                            <p class="text-muted mb-2"><strong>Overall Sentiment:</strong> <span id="overall-sentiment-label">N/A</span></p>
                            <div class="mb-3 chart-container" id="sentiment-distribution-chart-container">
                                <canvas id="sentiment-distribution-chart" height="150"></canvas>
                                <div class="empty-chart-message" style="display: none;">No sentiment data available.</div>
                            </div>
                            <div class="row text-center">
                                <div class="col">
                                    <h6>Caller Sentiment</h6>
                                    <p class="fs-4" id="caller-average-sentiment">N/A</p>
                                </div>
                                <div class="col">
                                    <h6>Lily's Sentiment</h6>
                                    <p class="fs-4" id="agent-average-sentiment">N/A</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-bar-chart-line-fill me-2"></i>Top Conversation Themes</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row">
                            <div class="col-md-7">
                                <div class="chart-container" id="top-themes-chart-container">
                                    <canvas id="top-themes-chart" height="200"></canvas>
                                    <div class="empty-chart-message" style="display: none;">No theme data available.</div>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <h6>Most Frequent Topics</h6>
                                <ul class="list-group list-group-flush small" id="top-themes-list">
                                    <!-- Theme list items will be populated here -->
                                    <li class="list-group-item">Loading...</li>
                                </ul>
                            </div>
                        </div>
                         <p class="small text-muted mt-2"><i class="bi bi-info-circle me-1"></i>Analysis is based on natural language processing of conversation transcripts. LLM-powered theme extraction identifies key topics across all conversations.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Sentiment Trends & Theme/Sentiment Correlation -->
        <div class="row mb-4">
            <div class="col-lg-7 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header">
                       <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Sentiment Trends Over Time</h5>
                    </div>
                    <div class="card-body p-4 chart-container" id="sentiment-trends-chart-container">
                         <canvas id="sentiment-trends-chart" height="120"></canvas>
                         <div class="empty-chart-message" style="display: none;">No sentiment trend data available.</div>
                         <p class="small text-muted mt-2"><i class="bi bi-info-circle me-1"></i>Shows how average sentiment has changed over the selected time period.</p>
                    </div>
                </div>
            </div>
             <div class="col-lg-5 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Theme & Sentiment Correlation</h5>
                    </div>
                    <div class="card-body p-4">
                        <table class="table table-sm table-hover small">
                            <thead>
                                <tr>
                                    <th>Theme</th>
                                    <th>Mentions</th>
                                    <th>Sentiment</th>
                                </tr>
                            </thead>
                            <tbody id="theme-correlation-table">
                                <!-- Correlation data will be populated here -->
                                <tr><td colspan="3" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                        <p class="small text-muted mt-2"><i class="bi bi-info-circle me-1"></i>Shows how different themes correlate with positive or negative sentiment.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 3: Common Questions & Concerns/Skepticism -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header">
                         <h5 class="mb-0"><i class="bi bi-question-circle-fill me-2"></i>Common Questions</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="accordion" id="common-questions-accordion">
                            <!-- Accordion items will be populated here -->
                            <div class="text-center p-3">Loading categories...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Concerns & Skepticism</h5>
                    </div>
                    <div class="card-body p-4">
                         <div class="accordion" id="concerns-skepticism-accordion">
                             <!-- Accordion items will be populated here -->
                             <div class="text-center p-3">Loading categories...</div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 4: Positive Interactions & AI Info -->
         <div class="row mb-4">
            <div class="col-lg-8 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header">
                         <h5 class="mb-0"><i class="bi bi-star-fill me-2"></i>Most Positive Caller Interactions (<span id="positive-interactions-count">0</span>)</h5>
                    </div>
                    <div class="card-body p-4">
                        <ul class="list-group list-group-flush small" id="positive-interactions-list">
                             <!-- Positive interaction items will be populated here -->
                             <li class="list-group-item text-center">Loading interactions...</li>
                        </ul>
                    </div>
                </div>
            </div>
             <div class="col-lg-4 mb-4">
                <div class="card h-100 shadow-sm bg-light">
                    <div class="card-body p-4 d-flex align-items-center">
                        <div>
                             <i class="bi bi-robot h1 me-3 text-primary"></i>
                        </div>
                        <div>
                            <h5 class="card-title">AI-Powered Analysis</h5>
                            <p class="card-text small">This analysis uses advanced Large Language Models to extract deeper insights from conversation transcripts. The themes, questions, and concerns are identified using natural language processing techniques to find patterns that might not be apparent with traditional analysis methods.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- /#analysis-content -->

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- Include Luxon adapter for Chart.js date handling -->
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
<!-- Page specific script -->
<script src="{{ url_for('static', filename='js/themes_sentiment_refactored.js') }}"></script>
{% endblock %} 