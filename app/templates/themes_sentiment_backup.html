{% extends "base.html" %}

{% block title %}Themes & Sentiment{% endblock %}

{% block head %}
    {{ super() }}
    <!-- Add any page-specific head elements here -->
    <!-- Include Chart.js if needed specifically for this page -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Consider adding custom CSS for layout if needed -->
{% endblock %}

{% block styles %}
    {{ super() }} 
<style>
    /* ===== Global Styles ===== */
    .card {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
        margin-bottom: 24px !important;
        border-radius: 8px !important;
        border: none !important;
    }
    
    .card-header {
        background-color: #f8f9fa !important;
        border-bottom: 1px solid #e9ecef !important;
        font-weight: 600 !important;
        padding: 12px 16px !important;
    }
    
    .card-body {
        padding: 16px !important;
    }
    
    /* Fixed height containers */
    .fixed-height-container {
        height: 300px !important;
        overflow-y: auto !important;
    }
    
    /* Chart containers */
    .chart-container {
        width: 100% !important;
        height: 300px !important;
        position: relative !important;
    }
    
    /* ===== Scrollable Areas ===== */
    /* Ensure all scrollable areas work properly */
    .scrollable {
        overflow-y: auto !important;
        max-height: 250px !important;
    }
    
    /* Extra styling for scrollbars so they're visible */
    .scrollable::-webkit-scrollbar {
        width: 10px !important;
        display: block !important;
    }
    
    .scrollable::-webkit-scrollbar-track {
        background: #f1f1f1 !important;
        border-radius: 10px !important;
    }
    
    .scrollable::-webkit-scrollbar-thumb {
        background: #888 !important;
        border-radius: 10px !important;
    }
    
    .scrollable::-webkit-scrollbar-thumb:hover {
        background: #555 !important;
    }
    
    /* ===== Accordion Styling ===== */
    .accordion-item {
        border: 1px solid #eee !important;
        margin-bottom: 8px !important;
        border-radius: 8px !important;
        overflow: hidden !important;
    }
    
    .accordion-button {
        padding: 12px 16px !important;
        background-color: #f8f9fa !important;
        font-weight: 600 !important;
    }
    
    .accordion-button:not(.collapsed) {
        background-color: #e9ecef !important;
        box-shadow: none !important;
    }
    
    .accordion-collapse {
        border-top: 1px solid #eee !important;
    }
    
    .accordion-body {
        padding: 16px !important;
        max-height: 200px !important;
        overflow-y: auto !important;
    }
    
    /* Force accordion-body to be scrollable */
    .accordion-collapse.show .accordion-body {
        overflow-y: auto !important;
        max-height: 200px !important;
    }
    
    /* ===== Category Containers ===== */
    .category-container .list-group-item {
        border: none !important;
        padding: 8px 12px !important;
        border-radius: 4px !important;
        margin-bottom: 4px !important;
        background-color: #f8f9fa !important;
    }
    
    .category-container .list-group-item:hover {
        background-color: #e9ecef !important;
    }
    
    /* ===== Sentiment Gauge ===== */
    .sentiment-gauge-container {
        display: flex !important;
        flex-wrap: wrap !important;
        justify-content: space-around !important;
        align-items: center !important;
        gap: 16px !important;
    }
    
    .sentiment-gauge {
        flex: 1 !important;
        min-width: 200px !important;
        text-align: center !important;
        padding: 16px !important;
        background-color: #f8f9fa !important;
        border-radius: 8px !important;
    }
    
    /* ===== Theme Correlation Table ===== */
    .theme-correlation-table {
        width: 100% !important;
    }
    
    .theme-correlation-table th, 
    .theme-correlation-table td {
        padding: 8px 12px !important;
        border-bottom: 1px solid #dee2e6 !important;
    }
    
    /* ===== Positive Interactions ===== */
    .positive-interaction-item {
        padding: 16px !important;
        border-radius: 8px !important;
        background-color: #f8f9fa !important;
        margin-bottom: 16px !important;
    }
    
    .positive-interaction-item blockquote {
        margin-bottom: 8px !important;
        font-style: italic !important;
        border-left: 3px solid #ddd !important;
        padding-left: 16px !important;
    }
    
    /* ===== Warning Banner ===== */
    .alert.alert-warning {
        background-color: #fff3cd !important;
        border-left: 4px solid #ffc107 !important;
        color: #856404 !important;
        padding: 16px !important;
        margin-bottom: 24px !important;
        border-radius: 4px !important;
    }
    
    /* ===== Empty State ===== */
    .empty-state {
        text-align: center !important;
        padding: 24px !important;
        background-color: #f8f9fa !important;
        border-radius: 8px !important;
    }
    
    .empty-state i {
        font-size: 48px !important;
        color: #6c757d !important;
        margin-bottom: 16px !important;
    }
    
    /* ===== Loading Indicators ===== */
    .loading-indicator {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 24px !important;
        min-height: 150px !important;
    }
    
    .loading-indicator .spinner-border {
        margin-bottom: 16px !important;
    }
    
    /* ===== Error Message ===== */
    .error-message {
        padding: 16px !important;
        background-color: #f8d7da !important;
        border-left: 4px solid #dc3545 !important;
        color: #721c24 !important;
        border-radius: 4px !important;
    }
    
    /* ===== Responsive Layout ===== */
    @media (max-width: 992px) {
        .fixed-height-container {
            height: 250px !important;
        }
        
        .chart-container {
            height: 250px !important;
        }
        
        .accordion-body {
            max-height: 150px !important;
        }
        
        .accordion-collapse.show .accordion-body {
            max-height: 150px !important;
        }
    }
    
    @media (max-width: 768px) {
        .fixed-height-container {
            height: 200px !important;
        }
        
        .chart-container {
            height: 200px !important;
        }
        
        .sentiment-gauge {
            min-width: 100% !important;
            margin-bottom: 16px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1>Themes &amp; Sentiment Analysis</h1>
            <p class="lead">Analyze common themes and sentiment patterns across conversations.</p>
        </div>
    </div>
    
    <!-- Date Range Selector -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Date Range</span>
                    <span id="conversation-count-display" class="badge bg-primary">Conversations: 0</span>
                </div>
                <div class="card-body">
                    <div class="btn-group mb-3" role="group" aria-label="Date range selection">
                        <button type="button" class="btn btn-outline-secondary" data-days="7">7 Days</button>
                        <button type="button" class="btn btn-outline-secondary" data-days="30">30 Days</button>
                        <button type="button" class="btn btn-outline-secondary" data-days="90">90 Days</button>
                        <button type="button" class="btn btn-outline-secondary" data-days="all">All</button>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-5">
                            <label for="start-date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start-date">
                        </div>
                        <div class="col-md-5">
                            <label for="end-date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end-date">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary w-100" id="apply-date-filter">Apply</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Warning Banner (hidden by default) -->
    <div class="row mb-4" id="warning-banner" style="display: none;">
        <div class="col-12">
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span id="warning-message">Notice: Displaying sample data. The analysis service did not return actual conversation data.</span>
            </div>
        </div>
    </div>
    
    <!-- Sentiment Overview -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">Sentiment Overview</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h5>Caller Sentiment</h5>
                                    <div class="progress mb-2">
                                        <div id="caller-sentiment-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                    </div>
                                    <span id="caller-sentiment-value">0.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h5>Agent Sentiment</h5>
                                    <div class="progress mb-2">
                                        <div id="agent-sentiment-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                    </div>
                                    <span id="agent-sentiment-value">0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <h5 class="text-center mb-3">Sentiment Distribution</h5>
                            <div id="sentiment-distribution-chart" class="chart-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">Sentiment Trends</div>
                <div class="card-body">
                    <div id="sentiment-trends-chart" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Common Topics -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">Top Themes</div>
                <div class="card-body">
                    <div id="top-themes-chart" class="chart-container"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">Common Questions</div>
                <div class="card-body p-0">
                    <div class="accordion" id="questionsAccordion">
                        <!-- Questions will be populated here -->
                        <div id="questions-placeholder" class="p-4 text-center text-muted">
                            <i class="bi bi-search"></i>
                            <p>No questions data available</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Customer Sentiment & Concerns -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">Concerns &amp; Skepticism</div>
                <div class="card-body p-0">
                    <div class="accordion" id="concernsAccordion">
                        <!-- Concerns will be populated here -->
                        <div id="concerns-placeholder" class="p-4 text-center text-muted">
                            <i class="bi bi-emoji-frown"></i>
                            <p>No concerns data available</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">Positive Interactions</div>
                <div class="card-body scrollable" id="positive-interactions-container">
                    <!-- Positive interactions will be populated here -->
                    <div id="positive-interactions-placeholder" class="text-center text-muted">
                        <i class="bi bi-emoji-smile"></i>
                        <p>No positive interactions data available</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Global variables
    let currentData = null;
    
    // --- Initialize on document load ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Themes & Sentiment page loaded");
        initializeDateRange();
        loadThemesData();
    });
    
    // --- Initialize date range selector ---
    function initializeDateRange() {
        // Set default dates (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        document.getElementById('start-date').valueAsDate = thirtyDaysAgo;
        document.getElementById('end-date').valueAsDate = today;
        
        // Set up event listeners for date range buttons
        document.querySelectorAll('.btn-group button').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('.btn-group button').forEach(b => {
                    b.classList.remove('btn-secondary');
                    b.classList.add('btn-outline-secondary');
                });
                
                // Add active class to clicked button
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-secondary');
                
                // Set the date range based on button
                const days = this.getAttribute('data-days');
                const today = new Date();
                let startDate = new Date();
                
                if (days === 'all') {
                    // Set to Jan 1 of current year
                    startDate = new Date(today.getFullYear(), 0, 1);
                } else {
                    // Set to X days ago
                    startDate.setDate(today.getDate() - parseInt(days));
                }
                
                document.getElementById('start-date').valueAsDate = startDate;
                document.getElementById('end-date').valueAsDate = today;
                
                // Apply filter automatically
                loadThemesData();
            });
        });
        
        // Set up event listener for apply button
        document.getElementById('apply-date-filter').addEventListener('click', loadThemesData);
        
        // Set 30 days as default
        document.querySelector('[data-days="30"]').click();
    }
    
    // --- Load themes data from API ---
    function loadThemesData() {
        // Show loading indicators
        showAllPlaceholders();
        
        // Get date range
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        // Create API URL with date parameters
        const apiUrl = `/api/themes-sentiment/full-analysis?start_date=${startDate}&end_date=${endDate}`;
        
        // Fetch data
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log("API Response:", data);
                currentData = data;
                
                // Check if this is fallback data
                if (data.is_fallback_data) {
                    showWarningBanner("Notice: Displaying sample data. The analysis service did not return actual conversation data.");
                } else if (data.error) {
                    showWarningBanner(`Error: ${data.error}`);
                } else {
                    hideWarningBanner();
                }
                
                // Update conversation count
                updateConversationCount(data.total_conversations_in_range || 0);
                
                // Display data
                displayFullThemesData(data);
                
                // Initialize scroll boxes
                setTimeout(initScrollBoxes, 500);
            })
            .catch(error => {
                console.error('Error fetching themes data:', error);
                displayErrorInAll(`Error: ${error.message}`);
            });
    }
    
    // --- Display full themes data ---
    function displayFullThemesData(data) {
        console.log("Displaying full themes data...");
        
        // Update conversation count
        const countDisplay = document.getElementById('conversation-count-display');
        if (countDisplay) {
            // Safely handle the case where total_conversations_in_range might be missing or zero
            const conversationCount = data.total_conversations_in_range !== undefined ? data.total_conversations_in_range : 0;
            countDisplay.textContent = `Conversations: ${conversationCount}`;
            
            // Make the count badge more prominent if we have data
            if (conversationCount > 0) {
                countDisplay.classList.remove('bg-secondary');
                countDisplay.classList.add('bg-primary');
            } else {
                countDisplay.classList.remove('bg-primary');
                countDisplay.classList.add('bg-secondary');
            }
        }
        
        // Show warning if there was an error
        if (data.error) {
            showWarningBanner(data.error);
        } else {
            hideWarningBanner();
        }
        
        // Create a progress indicator for each section
        showProgressState("Rendering sentiment overview...");
        
        // Use setTimeout to give the browser time to update UI between operations
        setTimeout(() => {
            // Display sentiment overview
            displaySentimentOverview(data.sentiment_overview);
            
            showProgressState("Rendering sentiment trends...");
            setTimeout(() => {
                // Display sentiment trends
                displaySentimentTrends(data.sentiment_trends);
                
                showProgressState("Rendering themes...");
                setTimeout(() => {
                    // Display top themes
                    displayTopThemes(data.top_themes);
                    
                    showProgressState("Rendering questions and concerns...");
                    setTimeout(() => {
                        // Display common questions and concerns
                        displayCollapsibleCategories(data.common_questions, 'questionsAccordion', 'questions-placeholder');
                        displayCollapsibleCategories(data.concerns_skepticism, 'concernsAccordion', 'concerns-placeholder');
                        
                        showProgressState("Rendering positive interactions...");
                        setTimeout(() => {
                            // Display positive interactions
                            displayPositiveInteractions(data.positive_interactions);
                            
                            // Finalize by initializing scroll boxes and clearing progress
                            setTimeout(() => {
                                hideProgressState();
                                initScrollBoxes();
                                console.log("Completed rendering all data sections");
                            }, 100);
                        }, 100);
                    }, 100);
                }, 100);
            }, 100);
        }, 100);
    }
    
    // --- Initialize all scrollable areas ---
    function initScrollBoxes() {
        console.log("Initializing scroll boxes");
        
        document.querySelectorAll('.accordion-collapse').forEach(collapseEl => {
            // Check if the element is not null and is already expanded
            if (collapseEl && collapseEl.classList.contains('show')) {
                const scrollableContent = collapseEl.querySelector('.scrollable-content');
                
                // Add null check before accessing properties
                if (scrollableContent) {
                    scrollableContent.style.maxHeight = '250px';
                    scrollableContent.style.overflowY = 'auto';
                }
            }
        });
        
        // Add event listeners to accordions
        document.querySelectorAll('.accordion-button').forEach(button => {
            if (!button) return;
            
            // Remove any existing listeners to avoid duplicates
            const newButton = button.cloneNode(true);
            if (button.parentNode) {
                button.parentNode.replaceChild(newButton, button);
            }
            
            newButton.addEventListener('click', function() {
                // Wait for collapse animation to complete
                setTimeout(() => {
                    const target = document.querySelector(this.getAttribute('data-bs-target'));
                    if (target && target.classList.contains('show')) {
                        const scrollable = target.querySelector('.scrollable-content');
                        if (scrollable) {
                            scrollable.style.maxHeight = '250px';
                            scrollable.style.overflowY = 'auto';
                        }
                    }
                }, 350); // Bootstrap transition takes 300ms
            });
        });
    }
    
    // --- Update conversation count display ---
    function updateConversationCount(count) {
        const countDisplay = document.getElementById('conversation-count-display');
        if (countDisplay) {
            countDisplay.textContent = `Conversations: ${count}`;
        }
    }
    
    // --- Display sentiment overview ---
    function displaySentimentOverview(overview) {
        if (!overview) {
            console.error("No sentiment overview data available");
            return;
        }
        
        // Update caller sentiment
        const callerValue = overview.caller_avg || 0;
        const callerPercent = Math.round(callerValue * 100);
        document.getElementById('caller-sentiment-value').textContent = callerValue.toFixed(2);
        const callerBar = document.getElementById('caller-sentiment-bar');
        callerBar.style.width = `${callerPercent}%`;
        callerBar.textContent = `${callerPercent}%`;
        callerBar.setAttribute('aria-valuenow', callerPercent);
        
        // Update agent sentiment
        const agentValue = overview.agent_avg || 0;
        const agentPercent = Math.round(agentValue * 100);
        document.getElementById('agent-sentiment-value').textContent = agentValue.toFixed(2);
        const agentBar = document.getElementById('agent-sentiment-bar');
        agentBar.style.width = `${agentPercent}%`;
        agentBar.textContent = `${agentPercent}%`;
        agentBar.setAttribute('aria-valuenow', agentPercent);
        
        // Display sentiment distribution
        displaySentimentDistribution(overview.distribution);
    }
    
    // --- Display sentiment trends ---
    function displaySentimentTrends(trends) {
        const ctx = document.getElementById('sentiment-trends-chart');
        
        // Clear any existing chart
        if (window.sentimentTrendsChart) {
            window.sentimentTrendsChart.destroy();
        }
        
        // If no data, display message
        if (!trends || trends.length === 0) {
            ctx.innerHTML = '<div class="text-center text-muted p-5"><i class="bi bi-bar-chart"></i><p>No trend data available</p></div>';
            return;
        }
        
        // Prepare data
        const labels = trends.map(item => item.period);
        const data = trends.map(item => item.sentiment);
        
        // Create new chart
        window.sentimentTrendsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Sentiment',
                    data: data,
                    borderColor: '#007bff',
                    tension: 0.1,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: 0,
                        max: 1,
                        title: {
                            display: true,
                            text: 'Sentiment Score'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    // --- Display top themes ---
    function displayTopThemes(themes) {
        const ctx = document.getElementById('top-themes-chart');
        
        // Clear any existing chart
        if (window.topThemesChart) {
            window.topThemesChart.destroy();
        }
        
        // If no data, display message
        if (!themes || themes.length === 0) {
            ctx.innerHTML = '<div class="text-center text-muted p-5"><i class="bi bi-tag"></i><p>No theme data available</p></div>';
            return;
        }
        
        // Sort by count (descending)
        themes.sort((a, b) => b.count - a.count);
        
        // Take top 10
        const topThemes = themes.slice(0, 10);
        
        // Prepare data
        const labels = topThemes.map(item => item.theme);
        const data = topThemes.map(item => item.count);
        
        // Create colors based on sentiment
        const colors = topThemes.map(item => {
            const sentiment = item.sentiment || 0.5;
            
            // Red for negative, yellow for neutral, green for positive
            if (sentiment < 0.3) return '#dc3545';
            if (sentiment < 0.6) return '#ffc107';
            return '#28a745';
        });
        
        // Create new chart
        window.topThemesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Mention Count',
                    data: data,
                    backgroundColor: colors
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Mentions'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    // --- Display collapsible categories (common questions, concerns, etc) ---
    function displayCollapsibleCategories(categories, accordionId, placeholderId) {
        console.log(`Displaying ${accordionId} with ${categories ? categories.length : 0} categories`);
        
        // Get the accordion element
        const accordion = document.getElementById(accordionId);
        if (!accordion) {
            console.error(`Accordion with ID ${accordionId} not found`);
            return;
        }
        
        // Get the placeholder element
        const placeholder = document.getElementById(placeholderId);
        
        // Check if we have categories
        if (!categories || categories.length === 0) {
            // If no categories, show a message in the placeholder
            if (placeholder) {
                placeholder.style.display = 'block';
            }
            // Clear the accordion
            accordion.innerHTML = '';
            return;
        }
        
        // Hide the placeholder
        if (placeholder) {
            placeholder.style.display = 'none';
        }
        
        // Generate HTML for the categories
        let html = '';
        categories.forEach((category, index) => {
            const categoryId = `category-${accordionId}-${index}`;
            const collapseId = `collapse-${accordionId}-${index}`;
            const headingId = `heading-${accordionId}-${index}`;
            
            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="${headingId}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                            ${category.category} <span class="badge bg-secondary ms-2">${category.count}</span>
                        </button>
                    </h2>
                    <div id="${collapseId}" class="accordion-collapse collapse" aria-labelledby="${headingId}" 
                         data-bs-parent="#${accordionId}">
                        <div class="accordion-body scrollable-content">
                            <ul class="list-group">
                                ${category.examples.map(example => {
                                    const exampleText = example.text || example;
                                    const conversationId = example.conversation_id || '';
                                    
                                    return `
                                        <li class="list-group-item">
                                            <blockquote class="border-start border-4 ps-3 mb-2">${exampleText}</blockquote>
                                            ${conversationId ? 
                                                `<div class="small text-muted">
                                                    Conversation ID: <a href="#" class="conversation-link" data-conversation-id="${conversationId}">${conversationId}</a>
                                                </div>` : ''}
                                        </li>
                                    `;
                                }).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        });
        
        // Set the HTML content
        accordion.innerHTML = html;
        
        // Add event listeners to conversation links
        document.querySelectorAll('.conversation-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const conversationId = this.getAttribute('data-conversation-id');
                if (conversationId) {
                    showConversationTranscript(conversationId);
                }
            });
        });
        
        // Initialize scrollable containers after a short delay to ensure DOM is ready
        setTimeout(() => {
            initScrollBoxes();
        }, 100);
    }
    
    // Function to show conversation transcript in a modal
    function showConversationTranscript(conversationId) {
        console.log(`Showing transcript for conversation: ${conversationId}`);
        
        // Show loading indicator
        if (!document.getElementById('transcriptModal')) {
            // Create modal if it doesn't exist
            const modalHtml = `
                <div class="modal fade" id="transcriptModal" tabindex="-1" aria-labelledby="transcriptModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="transcriptModalLabel">Conversation Transcript</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="transcriptModalBody">
                                <div class="d-flex justify-content-center py-5" id="transcriptLoader">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div id="transcriptContent" style="display: none;"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <a href="#" class="btn btn-primary" id="openFullViewBtn" target="_blank">Open in Full View</a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Show the modal
        const transcriptModal = new bootstrap.Modal(document.getElementById('transcriptModal'));
        transcriptModal.show();
        
        // Update the full view button URL
        const openFullViewBtn = document.getElementById('openFullViewBtn');
        openFullViewBtn.href = `/transcript/${conversationId}`;
        
        // Show loading indicator
        document.getElementById('transcriptLoader').style.display = 'flex';
        document.getElementById('transcriptContent').style.display = 'none';
        
        // Fetch conversation transcript
        fetch(`/api/conversation/${conversationId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Render the transcript
                renderTranscript(data, conversationId);
            })
            .catch(error => {
                console.error('Error fetching transcript:', error);
                document.getElementById('transcriptContent').innerHTML = `
                    <div class="alert alert-danger">
                        Failed to load transcript. Error: ${error.message}
                    </div>
                `;
                document.getElementById('transcriptLoader').style.display = 'none';
                document.getElementById('transcriptContent').style.display = 'block';
            });
    }
    
    // Function to render conversation transcript
    function renderTranscript(data, conversationId) {
        const transcriptContent = document.getElementById('transcriptContent');
        const transcriptLoader = document.getElementById('transcriptLoader');
        
        if (!data || !data.transcript || data.transcript.length === 0) {
            transcriptContent.innerHTML = '<div class="alert alert-warning">No transcript available for this conversation.</div>';
            transcriptLoader.style.display = 'none';
            transcriptContent.style.display = 'block';
            return;
        }
        
        // Build transcript HTML
        let transcriptHtml = `
            <div class="mb-3">
                <strong>Conversation ID:</strong> ${conversationId}<br>
                ${data.start_time ? `<strong>Start Time:</strong> ${new Date(data.start_time).toLocaleString()}<br>` : ''}
                ${data.duration ? `<strong>Duration:</strong> ${formatDuration(data.duration)}<br>` : ''}
            </div>
            <div class="conversation-transcript">
        `;
        
        // Add messages
        data.transcript.forEach(message => {
            const isAgent = message.role === 'assistant';
            const isUser = message.role === 'user';
            const avatar = isAgent ? 'L' : 'C';
            const speaker = isAgent ? 'Lily' : 'Curious Caller';
            const time = message.timestamp ? new Date(message.timestamp).toLocaleTimeString() : '';
            
            transcriptHtml += `
                <div class="message ${isAgent ? 'message-agent' : 'message-user'}">
                    <div class="message-avatar bg-${isAgent ? 'primary' : 'warning'}">${avatar}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">${speaker}</span>
                            ${time ? `<span class="message-time">${time}</span>` : ''}
                        </div>
                        <div class="message-text">${message.content}</div>
                    </div>
                </div>
            `;
        });
        
        transcriptHtml += '</div>';
        
        // Update the content
        transcriptContent.innerHTML = transcriptHtml;
        
        // Hide loader, show content
        transcriptLoader.style.display = 'none';
        transcriptContent.style.display = 'block';
    }
    
    // Helper function to format duration in seconds to "Xm XXs" format
    function formatDuration(seconds) {
        if (!seconds || isNaN(seconds)) return '0s';
        
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        
        if (minutes === 0) {
            return `${remainingSeconds}s`;
        }
        
        return `${minutes}m ${remainingSeconds}s`;
    }
    
    // --- Display sentiment distribution chart ---
    function displaySentimentDistribution(distribution) {
        console.log('Displaying sentiment distribution:', distribution);
        
        const chartContainer = document.getElementById('sentiment-distribution-chart');
        if (!chartContainer) {
            console.error('Sentiment distribution chart container not found');
            return;
        }
        
        // Clear any existing content or spinners
        chartContainer.innerHTML = '';
        
        // Check if we have valid distribution data
        if (!distribution || 
            typeof distribution.positive !== 'number' || 
            typeof distribution.negative !== 'number' || 
            typeof distribution.neutral !== 'number') {
            
            console.warn('Invalid sentiment distribution data:', distribution);
            chartContainer.innerHTML = '<div class="text-center p-3">No sentiment data available</div>';
            return;
        }
        
        // Calculate total
        const total = distribution.positive + distribution.negative + distribution.neutral;
        
        // If total is zero, show a message
        if (total === 0) {
            chartContainer.innerHTML = '<div class="text-center p-3">No sentiment data available</div>';
            return;
        }
        
        // Create a new canvas
        const canvas = document.createElement('canvas');
        chartContainer.appendChild(canvas);
        
        // Create the chart
        new Chart(canvas, {
            type: 'doughnut',
            data: {
                labels: ['Positive', 'Negative', 'Neutral'],
                datasets: [{
                    data: [
                        distribution.positive || 0,
                        distribution.negative || 0,
                        distribution.neutral || 0
                    ],
                    backgroundColor: [
                        'rgba(75, 192, 112, 0.8)',
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(201, 203, 207, 0.8)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 112, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(201, 203, 207, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // --- Display positive interactions ---
    function displayPositiveInteractions(interactions) {
        const container = document.getElementById('positive-interactions-container');
        
        // If no data, show placeholder
        if (!interactions || interactions.length === 0) {
            container.innerHTML = `
                <div id="positive-interactions-placeholder" class="text-center text-muted p-4">
                    <i class="bi bi-emoji-smile fs-4 mb-2"></i>
                    <p>No positive interactions data available</p>
                </div>
            `;
            return;
        }
        
        // Clear container
        container.innerHTML = '';
        
        // Add each interaction
        interactions.forEach(interaction => {
            const interactionDiv = document.createElement('div');
            interactionDiv.className = 'positive-interaction-item';
            
            const quote = document.createElement('blockquote');
            quote.className = 'mb-2';
            quote.textContent = interaction.text;
            
            const sentiment = document.createElement('div');
            sentiment.className = 'small text-muted';
            sentiment.innerHTML = `<strong>${interaction.speaker}</strong> - Sentiment: ${interaction.sentiment.toFixed(2)}`;
            
            interactionDiv.appendChild(quote);
            interactionDiv.appendChild(sentiment);
            container.appendChild(interactionDiv);
        });
    }
    
    // --- Warning banner functions ---
    function showWarningBanner(message) {
        const banner = document.getElementById('warning-banner');
        const messageEl = document.getElementById('warning-message');
        messageEl.textContent = message;
        banner.style.display = 'block';
    }
    
    function hideWarningBanner() {
        document.getElementById('warning-banner').style.display = 'none';
    }
    
    // --- Helper functions ---
    function showAllPlaceholders() {
        // Display loading message in each container
        const loadingHtml = `
            <div class="loading-indicator">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>Loading data...</div>
            </div>
        `;
        
        document.getElementById('sentiment-distribution-chart').innerHTML = loadingHtml;
        document.getElementById('sentiment-trends-chart').innerHTML = loadingHtml;
        document.getElementById('top-themes-chart').innerHTML = loadingHtml;
        document.getElementById('positive-interactions-container').innerHTML = loadingHtml;
        document.getElementById('questionsAccordion').innerHTML = loadingHtml;
        document.getElementById('concernsAccordion').innerHTML = loadingHtml;
    }
    
    function displayErrorInAll(errorMessage) {
        // Display error message in each container
        const errorHtml = `
            <div class="error-message">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                ${errorMessage}
            </div>
        `;
        
        document.getElementById('sentiment-distribution-chart').innerHTML = errorHtml;
        document.getElementById('sentiment-trends-chart').innerHTML = errorHtml;
        document.getElementById('top-themes-chart').innerHTML = errorHtml;
        document.getElementById('positive-interactions-container').innerHTML = errorHtml;
        document.getElementById('questionsAccordion').innerHTML = errorHtml;
        document.getElementById('concernsAccordion').innerHTML = errorHtml;
    }
    
    // Show a progress state message
    function showProgressState(message) {
        const progressElement = document.getElementById('progress-state') || createProgressElement();
        progressElement.textContent = message;
        progressElement.style.display = 'block';
    }
    
    // Hide the progress state message
    function hideProgressState() {
        const progressElement = document.getElementById('progress-state');
        if (progressElement) {
            progressElement.style.display = 'none';
        }
    }
    
    // Create a progress element if it doesn't exist
    function createProgressElement() {
        const element = document.createElement('div');
        element.id = 'progress-state';
        element.className = 'alert alert-info position-fixed bottom-0 end-0 m-3';
        element.style.zIndex = '1050';
        document.body.appendChild(element);
        return element;
    }
</script>
{% endblock %} 